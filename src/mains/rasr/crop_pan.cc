 // ========================================================================
// Program CROP_PAN utilizes ImageMagick's conversion program to crop
// panoramas generated by AutoPanoPro down to specified, uniform
// widths and heights measured in pixels.
// ========================================================================
// Last updated on 8/11/09; 8/17/09; 12/23/09; 4/23/10
// ========================================================================

#include <iostream>
#include <string>

#include "general/filefuncs.h"
#include "image/imagefuncs.h"
#include "general/outputfuncs.h"
#include "general/stringfuncs.h"
#include "general/sysfuncs.h"

using std::cin;
using std::cout;
using std::endl;
using std::ofstream;
using std::string;

// ==========================================================================
int main( int argc, char** argv )
{
//   string basefilename="panel";
   string basefilename="pano1";
   cout << "Enter panorama base filename:" << endl;
   cin >> basefilename;
  
   string imagedir="./";
//   cout << "Enter subdir containing panorama image:"<< endl;
//   cin >> imagedir;

   string suffix=".jpg";

//   string panorama_filename=imagedir+basefilename+suffix;
   string panorama_filename="ladybug.jpg";
   cout << "panorama_filename = " << panorama_filename << endl;

// On touchy2, we determined xoffset,yoffset and xstop,ystop values
// using GIMP.  Just read off cursor's position from GIMP's lower left
// corner:

// Offset location = image's upper left pixel:

//   int n_iters=5;
//   int n_iters=8;
//   int n_iters=7;	// Fish eye lens expt performed on 12/23/09
   int n_iters=10;
//   int n_iters=12;
//   int horiz_size=1841;
//   int horiz_size=3500;
//   int horiz_size=5000;
   int horiz_size=5400;

   for (int iter=0; iter<n_iters; iter++)
   {
      int xoffset=iter*horiz_size/n_iters;
      int yoffset=0;	// Fish-eye lens
//      int yoffset=20;	// Sarah's camera
//      int yoffset=60;	// Peter's camera
      int xstop=(iter+1)*horiz_size/n_iters;
//      int ystop=535;	// Fish-eye camera
//      int ystop=540;	// Sarah's camera
//      int ystop=700;	// Peter's camera	
//      int ystop=1400;	// ladybug
      int ystop=2700;	// ladybug
      int width=xstop-xoffset;
      int height=ystop-yoffset;
      const int n_digits=1;
      int image_skip=1;

      cout << "iter = " << iter 
           << " width = " << width
           << " xoffset = " << xoffset << endl;

      string filename=basefilename+"_"
         +stringfunc::integer_to_string(iter,n_digits)+suffix;
      filename=imagedir+filename;

      string unix_command="cp "+panorama_filename+" "+filename;
      sysfunc::unix_command(unix_command);

      cout << "Cropping file = " << filename << endl;
      imagefunc::crop_image(filename,width,height,xoffset,yoffset);
   } // loop over iter index
}
