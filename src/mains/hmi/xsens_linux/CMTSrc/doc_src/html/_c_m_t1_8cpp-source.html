<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>CMT: CMT1.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<div class="logo">
    <img src="LogoXsensMotion.gif" alt="Xsens Logo" style="float: right;" />
</div>

<!-- Generated by Doxygen 1.5.1-p1 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="namespaces.html"><span>Namespaces</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<h1>CMT1.cpp</h1><a href="_c_m_t1_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00025"></a>00025 <span class="preprocessor">#include "<a class="code" href="_c_m_t1_8h.html">cmt1.h</a>"</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#ifndef _WIN32</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span><span class="preprocessor">#       include &lt;unistd.h&gt;</span>              <span class="comment">// close</span>
<a name="l00029"></a>00029 <span class="preprocessor">#       include &lt;sys/ioctl.h&gt;</span>   <span class="comment">// ioctl</span>
<a name="l00030"></a>00030 <span class="preprocessor">#       include &lt;fcntl.h&gt;</span>               <span class="comment">// open, O_RDWR</span>
<a name="l00031"></a>00031 <span class="preprocessor">#       include &lt;string.h&gt;</span>              <span class="comment">// strcpy</span>
<a name="l00032"></a>00032 <span class="preprocessor">#       include &lt;malloc.h&gt;</span>              <span class="comment">// malloc</span>
<a name="l00033"></a>00033 <span class="preprocessor">#   include &lt;sys/param.h&gt;</span>
<a name="l00034"></a>00034 <span class="comment">// We have to redefine PATH_MAX from 4096 to CMT_MAX_FILENAME_LENGTH to mainain compatibility</span>
<a name="l00035"></a>00035 <span class="comment">// The PATH_MAX definition is used by realpath() to determine the maximum path length. According</span>
<a name="l00036"></a>00036 <span class="comment">// to the realpath (3) man page, the function is best avoided and it might be necessary to</span>
<a name="l00037"></a>00037 <span class="comment">// write a custom function for it (couldn't find a proper replacement).</span>
<a name="l00038"></a>00038 <span class="preprocessor">#   undef PATH_MAX</span>
<a name="l00039"></a><a class="code" href="_c_m_t1_8cpp.html#e688d728e1acdfe5988c7db45d6f0166">00039</a> <span class="preprocessor"></span><span class="preprocessor">#   define PATH_MAX CMT_MAX_FILENAME_LENGTH</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#   include &lt;stdlib.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#else</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span><span class="preprocessor">#   include &lt;io.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#endif</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00045"></a>00045 <span class="preprocessor">#ifndef _CRT_SECURE_NO_DEPRECATE</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor">#       define _CRT_SECURE_NO_DEPRECATE</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="preprocessor">#       ifdef _WIN32</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#               pragma warning(disable:4996)</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">#       endif</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>
<a name="l00052"></a>00052 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="preprocessor">#       define FSEEK(x)         _fseeki64(m_handle, x, SEEK_SET)</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">#       define FSEEK_R(x)       _fseeki64(m_handle, x, SEEK_END)</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="preprocessor">#       define FTELL()          _ftelli64(m_handle)</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00057"></a><a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">00057</a> <span class="preprocessor"></span><span class="preprocessor">#       define FSEEK(x)         fseeko(m_handle, x, SEEK_SET)</span>
<a name="l00058"></a><a class="code" href="_c_m_t1_8cpp.html#de70724c8be1c5773b9d58b9ceba1ac0">00058</a> <span class="preprocessor"></span><span class="preprocessor">#       define FSEEK_R(x)       fseeko(m_handle, x, SEEK_END)</span>
<a name="l00059"></a><a class="code" href="_c_m_t1_8cpp.html#6cb7c2b71feb2bb1ab857bb639f79b66">00059</a> <span class="preprocessor"></span><span class="preprocessor">#       define FTELL()          ftello(m_handle)</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span>
<a name="l00062"></a>00062 <span class="comment">// The namespace of all Xsens software since 2006.</span>
<a name="l00063"></a><a class="code" href="namespacexsens.html">00063</a> <span class="keyword">namespace </span>xsens {
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="preprocessor">#ifndef _WIN32</span>
<a name="l00066"></a><a class="code" href="namespacexsens.html#83d67697db21fcfda80de872daed93ba">00066</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="namespacexsens.html#83d67697db21fcfda80de872daed93ba">_wcsnicmp</a>(<span class="keyword">const</span> <span class="keywordtype">wchar_t</span>* s1, <span class="keyword">const</span> <span class="keywordtype">wchar_t</span>* s2,<span class="keywordtype">int</span> count)
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; count; ++i, ++s1, ++s2)
<a name="l00069"></a>00069                 <span class="keywordflow">if</span> (*s1 == L<span class="charliteral">'\0'</span>)
<a name="l00070"></a>00070                         <span class="keywordflow">if</span> (*s2 == L<span class="charliteral">'\0'</span>)
<a name="l00071"></a>00071                                 <span class="keywordflow">return</span> 0;
<a name="l00072"></a>00072                         <span class="keywordflow">else</span>
<a name="l00073"></a>00073                                 <span class="keywordflow">return</span> -1;
<a name="l00074"></a>00074                 <span class="keywordflow">else</span>
<a name="l00075"></a>00075                         <span class="keywordflow">if</span> (*s2 == L<span class="charliteral">'\0'</span>)
<a name="l00076"></a>00076                                 <span class="keywordflow">return</span> 1;
<a name="l00077"></a>00077                         <span class="keywordflow">else</span>
<a name="l00078"></a>00078                                 <span class="keywordflow">if</span> (*s1 &lt; *s2)
<a name="l00079"></a>00079                                         <span class="keywordflow">return</span> -1;
<a name="l00080"></a>00080                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s1 &gt; *s2)
<a name="l00081"></a>00081                                         <span class="keywordflow">return</span> 1;
<a name="l00082"></a>00082         <span class="keywordflow">return</span> 0;
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 <span class="preprocessor">#endif</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="preprocessor">#if defined(_DEBUG) || defined(_LOG_ALWAYS)</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span><span class="preprocessor">        #if !defined(_LOG_TO_DBVIEW)</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span><span class="preprocessor">                #ifdef _LOG_TO_STDOUT</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span><span class="preprocessor">                #else   // !dbview &amp;&amp; !stdout</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>                        FILE* debug_log_fp = NULL;
<a name="l00092"></a>00092                         int32_t debug_log_valid = 0;
<a name="l00093"></a>00093                         
<a name="l00094"></a>00094                         FILE* debug_qlog_fp = NULL;
<a name="l00095"></a>00095                         int32_t debug_qlog_valid = 0;
<a name="l00096"></a>00096 <span class="preprocessor">                #endif</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span><span class="preprocessor">        #endif</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span>
<a name="l00099"></a>00099 <span class="comment">// write to a log file/screen/debug-stream</span>
<a name="l00100"></a>00100 <span class="keywordtype">void</span> <a class="code" href="_c_m_t1_8h.html#990d19ec2de73091adbb95d7057f21a2">CMTLOG</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *str, ...)
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102 <span class="preprocessor">        #ifdef _LOG_TO_STDOUT</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span>                va_list ptr;
<a name="l00104"></a>00104                 va_start(ptr,str);
<a name="l00105"></a>00105                 vprintf(str,ptr);
<a name="l00106"></a>00106 <span class="preprocessor">        #else</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span><span class="preprocessor">        #ifdef _LOG_TO_DBVIEW</span>
<a name="l00108"></a>00108 <span class="preprocessor"></span>                <span class="keywordtype">char</span> buf[2048];
<a name="l00109"></a>00109 
<a name="l00110"></a>00110                 va_list ptr;
<a name="l00111"></a>00111                 va_start(ptr,str);
<a name="l00112"></a>00112                 vsprintf(buf,str,ptr);
<a name="l00113"></a>00113 
<a name="l00114"></a>00114                 OutputDebugString(buf);
<a name="l00115"></a>00115 <span class="preprocessor">        #else</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (debug_log_valid == 0)
<a name="l00117"></a>00117                 {
<a name="l00118"></a>00118                         fopen_s(&amp;debug_log_fp,<span class="stringliteral">"debug_log_cmt.log"</span>,<span class="stringliteral">"w"</span>);
<a name="l00119"></a>00119                         <span class="keywordflow">if</span> (debug_log_fp != NULL)
<a name="l00120"></a>00120                                 debug_log_valid = 1;
<a name="l00121"></a>00121                         <span class="keywordflow">else</span>
<a name="l00122"></a>00122                                 debug_log_valid = -1;
<a name="l00123"></a>00123                 }
<a name="l00124"></a>00124                 <span class="keywordflow">if</span> (debug_log_valid == 1)
<a name="l00125"></a>00125                 {
<a name="l00126"></a>00126                         <span class="keywordtype">char</span> buf[2048];
<a name="l00127"></a>00127 
<a name="l00128"></a>00128                         va_list ptr;
<a name="l00129"></a>00129                         va_start(ptr,str);
<a name="l00130"></a>00130                         int32_t sz = vsprintf_s(buf,str,ptr);
<a name="l00131"></a>00131 
<a name="l00132"></a>00132                         uint32_t nw = <a class="code" href="namespacexsens.html#00d5dce92611428c34961bee5893155f">getTimeOfDay</a>();
<a name="l00133"></a>00133                         fprintf(debug_log_fp,<span class="stringliteral">"%5u.%03u %s"</span>,nw/1000,nw%1000,buf);
<a name="l00134"></a>00134                         <span class="comment">//fwrite(buf,1,sz,debug_log_fp);</span>
<a name="l00135"></a>00135                         fflush(debug_log_fp);
<a name="l00136"></a>00136                 }
<a name="l00137"></a>00137 <span class="preprocessor">        #endif</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span><span class="preprocessor">        #endif</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span>}
<a name="l00140"></a>00140 <span class="preprocessor">#endif</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>
<a name="l00142"></a>00142 <span class="comment">// maybe log to nothing at this level</span>
<a name="l00143"></a>00143 <span class="preprocessor">#ifdef _LOG_CMT1</span>
<a name="l00144"></a>00144 <span class="preprocessor"></span><span class="preprocessor">        #define CMT1LOG         CMTLOG</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00146"></a><a class="code" href="_c_m_t1_8cpp.html#ed3b2d392c8026452ab1558ef59c3fb4">00146</a> <span class="preprocessor"></span><span class="preprocessor">        #define CMT1LOG(...)</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span>
<a name="l00152"></a>00152 
<a name="l00154"></a>00154 <span class="comment">// Default constructor, initializes all members to their default values.</span>
<a name="l00155"></a><a class="code" href="classxsens_1_1_cmt1s.html#04d25a1665542ca7fa840db99fd91a07">00155</a> <a class="code" href="classxsens_1_1_cmt1s.html#04d25a1665542ca7fa840db99fd91a07">Cmt1s::Cmt1s</a>() :
<a name="l00156"></a>00156         m_onBytesReceived(NULL)
<a name="l00157"></a>00157 {
<a name="l00158"></a>00158         <a class="code" href="classxsens_1_1_cmt1s.html#168c7ac9ed1e5d52f5bddbc0e104ffea">m_port</a> = 0;
<a name="l00159"></a>00159         <a class="code" href="classxsens_1_1_cmt1s.html#e24943020d686262cc9e816000f3d3bd">m_isOpen</a> = <span class="keyword">false</span>;
<a name="l00160"></a>00160         <a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00161"></a>00161         <a class="code" href="classxsens_1_1_cmt1s.html#82faa3cd6d194a335b52f0a4b49be46c">m_timeout</a> = <a class="code" href="_c_m_tdef_8h.html#509daae051f48c297ddc9ced2c55a6c2">CMT1_DEFAULT_TIMEOUT</a>;
<a name="l00162"></a>00162         <a class="code" href="classxsens_1_1_cmt1s.html#0fed0152b75e196817c4d62a92bc5456">m_endTime</a> = 0;
<a name="l00163"></a>00163         <a class="code" href="classxsens_1_1_cmt1s.html#699e276dea05aed9b120d9668228f842">m_baudrate</a> = 0;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 <span class="preprocessor">        #ifdef _LOG_RX_TX</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span>                rx_log = NULL;
<a name="l00167"></a>00167                 tx_log = NULL;
<a name="l00168"></a>00168 <span class="preprocessor">        #endif</span>
<a name="l00169"></a>00169 <span class="preprocessor"></span>}
<a name="l00170"></a>00170 
<a name="l00172"></a>00172 <span class="comment">// Destructor, de-initializes, frees memory allocated for buffers, etc.</span>
<a name="l00173"></a><a class="code" href="classxsens_1_1_cmt1s.html#cb907ca4246dc9b76f38dfdf46a2d212">00173</a> <a class="code" href="classxsens_1_1_cmt1s.html#cb907ca4246dc9b76f38dfdf46a2d212">Cmt1s::~Cmt1s</a>()
<a name="l00174"></a>00174 {
<a name="l00175"></a>00175         <a class="code" href="classxsens_1_1_cmt1s.html#29d64fe8e43430225b02450cac4a65eb">close</a>();
<a name="l00176"></a>00176 }
<a name="l00177"></a>00177 
<a name="l00179"></a>00179 <span class="comment">// Close the serial communication port.</span>
<a name="l00180"></a><a class="code" href="classxsens_1_1_cmt1s.html#29d64fe8e43430225b02450cac4a65eb">00180</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1s.html#29d64fe8e43430225b02450cac4a65eb">Cmt1s::close</a> (<span class="keywordtype">void</span>)
<a name="l00181"></a>00181 {
<a name="l00182"></a>00182 <span class="preprocessor">        #ifdef _LOG_RX_TX</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (rx_log != NULL)
<a name="l00184"></a>00184                         fclose(rx_log);
<a name="l00185"></a>00185                 <span class="keywordflow">if</span> (tx_log != NULL)
<a name="l00186"></a>00186                         fclose(tx_log);
<a name="l00187"></a>00187                 rx_log = NULL;
<a name="l00188"></a>00188                 tx_log = NULL;
<a name="l00189"></a>00189 <span class="preprocessor">        #endif</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1s.html#e24943020d686262cc9e816000f3d3bd">m_isOpen</a>)
<a name="l00191"></a>00191                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f286030c8ef758b70a66bed69f0e43e70">XRV_NOPORTOPEN</a>;
<a name="l00192"></a>00192         
<a name="l00193"></a>00193 <span class="preprocessor">        #ifdef _WIN32</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>                ::FlushFileBuffers(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>);
<a name="l00195"></a>00195                 <span class="comment">// read all data before closing the handle, a Flush is not enough for FTDI devices unfortunately</span>
<a name="l00196"></a>00196                 <span class="comment">// we first need to set the COMM timeouts to instantly return when no more data is available</span>
<a name="l00197"></a>00197                         COMMTIMEOUTS cto;
<a name="l00198"></a>00198                         ::GetCommTimeouts(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>,&amp;cto);
<a name="l00199"></a>00199                         cto.ReadIntervalTimeout = MAXDWORD;
<a name="l00200"></a>00200                         cto.ReadTotalTimeoutConstant = 0;
<a name="l00201"></a>00201                         cto.ReadTotalTimeoutMultiplier = 0;
<a name="l00202"></a>00202                         ::SetCommTimeouts(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>,&amp;cto);
<a name="l00203"></a>00203                         <span class="keywordtype">char</span> buffer[1024];
<a name="l00204"></a>00204                         uint32_t length;
<a name="l00205"></a>00205                         <span class="keywordflow">do</span> {
<a name="l00206"></a>00206                                 ::ReadFile(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, buffer, 1024, &amp;length, NULL);
<a name="l00207"></a>00207                         } <span class="keywordflow">while</span> (length &gt; 0);
<a name="l00208"></a>00208                 ::CloseHandle(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>);
<a name="l00209"></a>00209 <span class="preprocessor">        #else</span>
<a name="l00210"></a>00210 <span class="preprocessor"></span><a class="code" href="classxsens_1_1_cmt1s.html#29d64fe8e43430225b02450cac4a65eb">		::close</a>(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>);
<a name="l00211"></a>00211 <span class="preprocessor">        #endif</span>
<a name="l00212"></a>00212 <span class="preprocessor"></span>        <a class="code" href="classxsens_1_1_cmt1s.html#e24943020d686262cc9e816000f3d3bd">m_isOpen</a> = <span class="keyword">false</span>;
<a name="l00213"></a>00213         <a class="code" href="classxsens_1_1_cmt1s.html#0fed0152b75e196817c4d62a92bc5456">m_endTime</a> = 0;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00216"></a>00216 }
<a name="l00217"></a>00217 
<a name="l00219"></a>00219 <span class="comment">// Manipulate the Serial control lines</span>
<a name="l00220"></a><a class="code" href="classxsens_1_1_cmt1s.html#59ea4755515aee0d93c76fd1298388f0">00220</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1s.html#59ea4755515aee0d93c76fd1298388f0">Cmt1s::escape</a> (<span class="keyword">const</span> <a class="code" href="_c_m_tdef_8h.html#bc069da3eb53ee907bad489b85346619">CmtControlLine</a> mask, <span class="keyword">const</span> <a class="code" href="_c_m_tdef_8h.html#bc069da3eb53ee907bad489b85346619">CmtControlLine</a> state)
<a name="l00221"></a>00221 {
<a name="l00222"></a>00222         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1s.html#e24943020d686262cc9e816000f3d3bd">m_isOpen</a>)
<a name="l00223"></a>00223                 <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f286030c8ef758b70a66bed69f0e43e70">XRV_NOPORTOPEN</a>);
<a name="l00224"></a>00224 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span>        BOOL rv = 0;
<a name="l00226"></a>00226         <span class="keywordflow">if</span> (mask &amp; <a class="code" href="_c_m_tdef_8h.html#bc069da3eb53ee907bad489b85346619c433913b3a16e10a1ed4a73b117a0d46">CMT_CONTROL_DTR</a>)
<a name="l00227"></a>00227         {
<a name="l00228"></a>00228                 <span class="keywordflow">if</span> (state &amp; CMT_CONTROL_DTR)
<a name="l00229"></a>00229                         rv = EscapeCommFunction(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>,SETDTR);
<a name="l00230"></a>00230                 <span class="keywordflow">else</span>
<a name="l00231"></a>00231                         rv = EscapeCommFunction(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>,CLRDTR);
<a name="l00232"></a>00232         }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234         <span class="keywordflow">if</span> (mask &amp; <a class="code" href="_c_m_tdef_8h.html#bc069da3eb53ee907bad489b853466198658554c8584a49416d4601a169c84c1">CMT_CONTROL_RTS</a>)
<a name="l00235"></a>00235         {
<a name="l00236"></a>00236                 <span class="keywordflow">if</span> (state &amp; CMT_CONTROL_RTS)
<a name="l00237"></a>00237                         rv = EscapeCommFunction(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>,SETRTS);
<a name="l00238"></a>00238                 <span class="keywordflow">else</span>
<a name="l00239"></a>00239                         rv = EscapeCommFunction(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>,CLRRTS);
<a name="l00240"></a>00240         }
<a name="l00241"></a>00241         <span class="keywordflow">if</span> (rv)
<a name="l00242"></a>00242                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00243"></a>00243         <span class="keywordflow">else</span>
<a name="l00244"></a>00244                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f8b48357051e4a998c816b2ca8479f9f8">XRV_ERROR</a>;
<a name="l00245"></a>00245 <span class="preprocessor">#else</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span>        <span class="keywordtype">bool</span> rv = <span class="keyword">true</span>;
<a name="l00247"></a>00247         int32_t status;
<a name="l00248"></a>00248         <span class="keywordflow">if</span> (mask &amp; CMT_CONTROL_DTR)
<a name="l00249"></a>00249         {
<a name="l00250"></a>00250                 <span class="keywordflow">if</span> (ioctl(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, TIOCMGET, &amp;status) == -1)
<a name="l00251"></a>00251                 {
<a name="l00252"></a>00252                         <span class="keywordflow">if</span> (state &amp; CMT_CONTROL_DTR) status |= TIOCM_DTR;
<a name="l00253"></a>00253                         <span class="keywordflow">else</span> status &amp;= ~TIOCM_DTR;
<a name="l00254"></a>00254                         rv = (ioctl(m_handle, TIOCMSET, &amp;status) == -1);
<a name="l00255"></a>00255                 }
<a name="l00256"></a>00256                 <span class="keywordflow">else</span>
<a name="l00257"></a>00257                         rv = <span class="keyword">false</span>;
<a name="l00258"></a>00258         }
<a name="l00259"></a>00259         <span class="keywordflow">if</span> (rv &amp;&amp; (mask &amp; CMT_CONTROL_RTS))
<a name="l00260"></a>00260         {
<a name="l00261"></a>00261                 <span class="keywordflow">if</span> (ioctl(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, TIOCMGET, &amp;status) == -1)
<a name="l00262"></a>00262                 {
<a name="l00263"></a>00263                         <span class="keywordflow">if</span> (state &amp; CMT_CONTROL_RTS) status |= TIOCM_RTS;
<a name="l00264"></a>00264                         <span class="keywordflow">else</span> status &amp;= ~TIOCM_RTS;
<a name="l00265"></a>00265                         rv = (ioctl(m_handle, TIOCMSET, &amp;status) == -1);
<a name="l00266"></a>00266                 }
<a name="l00267"></a>00267                 <span class="keywordflow">else</span>
<a name="l00268"></a>00268                         rv = <span class="keyword">false</span>;
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270         <span class="keywordflow">if</span> (rv)
<a name="l00271"></a>00271                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00272"></a>00272         <span class="keywordflow">else</span>
<a name="l00273"></a>00273                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f8b48357051e4a998c816b2ca8479f9f8">XRV_ERROR</a>;
<a name="l00274"></a>00274 <span class="preprocessor">#endif</span>
<a name="l00275"></a>00275 <span class="preprocessor"></span>}
<a name="l00276"></a>00276 
<a name="l00278"></a>00278 <span class="comment">// Flush all data to be transmitted / received.</span>
<a name="l00279"></a><a class="code" href="classxsens_1_1_cmt1s.html#99c68d96454c25926a8c21fe0f47538c">00279</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1s.html#99c68d96454c25926a8c21fe0f47538c">Cmt1s::flushData</a> (<span class="keywordtype">void</span>)
<a name="l00280"></a>00280 {
<a name="l00281"></a>00281 <span class="preprocessor">        #ifdef _WIN32</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span>                <span class="comment">// Remove any 'old' data in buffer</span>
<a name="l00283"></a>00283                 PurgeComm(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, PURGE_TXCLEAR | PURGE_RXCLEAR);
<a name="l00284"></a>00284 <span class="preprocessor">        #else</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span>                tcflush(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, TCIOFLUSH);
<a name="l00286"></a>00286 <span class="preprocessor">        #endif</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span>        <a class="code" href="classxsens_1_1_cmt1s.html#0fed0152b75e196817c4d62a92bc5456">m_endTime</a> = 0;
<a name="l00288"></a>00288         <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>);
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00292"></a>00292 <span class="comment">// Open a communication channel to the given serial port name.</span>
<a name="l00293"></a><a class="code" href="classxsens_1_1_cmt1s.html#31c11cd69aba26459cbd57b5f55b4797">00293</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1s.html#31c11cd69aba26459cbd57b5f55b4797">Cmt1s::open</a>(  <span class="keyword">const</span> <span class="keywordtype">char</span> *portName,
<a name="l00294"></a>00294                                                 <span class="keyword">const</span> uint32_t baudRate,
<a name="l00295"></a>00295                                                 uint32_t readBufSize,
<a name="l00296"></a>00296                                                 uint32_t writeBufSize)
<a name="l00297"></a>00297 {
<a name="l00298"></a>00298         <a class="code" href="classxsens_1_1_cmt1s.html#0fed0152b75e196817c4d62a92bc5456">m_endTime</a> = 0;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300         <a class="code" href="_c_m_t1_8cpp.html#ed3b2d392c8026452ab1558ef59c3fb4">CMT1LOG</a>(<span class="stringliteral">"L1: Open port %s at %d baud\n"</span>, portName, baudRate);
<a name="l00301"></a>00301 
<a name="l00302"></a>00302         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1s.html#e24943020d686262cc9e816000f3d3bd">m_isOpen</a>)
<a name="l00303"></a>00303         {
<a name="l00304"></a>00304                 <a class="code" href="_c_m_t1_8cpp.html#ed3b2d392c8026452ab1558ef59c3fb4">CMT1LOG</a>(<span class="stringliteral">"L1: Port already open\n"</span>);
<a name="l00305"></a>00305                 <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f16ebfc281a5629d2ace0945e742e2a14">XRV_ALREADYOPEN</a>);
<a name="l00306"></a>00306         }
<a name="l00307"></a>00307         <a class="code" href="classxsens_1_1_cmt1s.html#699e276dea05aed9b120d9668228f842">m_baudrate</a> = baudRate;
<a name="l00308"></a>00308         
<a name="l00309"></a>00309 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00310"></a>00310 <span class="preprocessor"></span>        <span class="keywordtype">char</span> winPortName[32];
<a name="l00311"></a>00311         
<a name="l00312"></a>00312         <span class="comment">// Open port</span>
<a name="l00313"></a>00313         sprintf(winPortName, <span class="stringliteral">"\\\\.\\%s"</span>, portName);
<a name="l00314"></a>00314         <a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a> = CreateFile(winPortName, GENERIC_READ | GENERIC_WRITE, 0, NULL,
<a name="l00315"></a>00315                                                                         OPEN_EXISTING, 0, NULL);
<a name="l00316"></a>00316         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a> == INVALID_HANDLE_VALUE)
<a name="l00317"></a>00317         {
<a name="l00318"></a>00318                 <a class="code" href="_c_m_t1_8cpp.html#ed3b2d392c8026452ab1558ef59c3fb4">CMT1LOG</a>(<span class="stringliteral">"L1: Port cannot be opened\n"</span>);
<a name="l00319"></a>00319                 <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f21d923493c349ed671e995d6cb1cb32c">XRV_INPUTCANNOTBEOPENED</a>);
<a name="l00320"></a>00320         }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322         <span class="comment">// Once here, port is open</span>
<a name="l00323"></a>00323         <a class="code" href="classxsens_1_1_cmt1s.html#e24943020d686262cc9e816000f3d3bd">m_isOpen</a> = <span class="keyword">true</span>;
<a name="l00324"></a>00324 
<a name="l00325"></a>00325         <span class="comment">//Get the current state &amp; then change it</span>
<a name="l00326"></a>00326         GetCommState(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, &amp;<a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>);   <span class="comment">// Get current state</span>
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         <a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>.BaudRate = baudRate;                        <span class="comment">// Setup the baud rate</span>
<a name="l00329"></a>00329         <a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>.Parity = NOPARITY;                          <span class="comment">// Setup the Parity</span>
<a name="l00330"></a>00330         <a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>.ByteSize = 8;                                       <span class="comment">// Setup the data bits</span>
<a name="l00331"></a>00331         <a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>.StopBits = TWOSTOPBITS;                     <span class="comment">// Setup the stop bits</span>
<a name="l00332"></a>00332         <a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>.fDsrSensitivity = FALSE;            <span class="comment">// Setup the flow control </span>
<a name="l00333"></a>00333         <a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>.fOutxCtsFlow = FALSE;                       <span class="comment">// NoFlowControl:</span>
<a name="l00334"></a>00334         <a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>.fOutxDsrFlow = FALSE;
<a name="l00335"></a>00335         <a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>.fOutX = FALSE;
<a name="l00336"></a>00336         <a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>.fInX = FALSE;
<a name="l00337"></a>00337         <span class="keywordflow">if</span> (!SetCommState(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, (LPDCB)&amp;<a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>)) {<span class="comment">// Set new state</span>
<a name="l00338"></a>00338                 <span class="comment">// Bluetooth ports cannot always be opened with 2 stopbits</span>
<a name="l00339"></a>00339                 <span class="comment">// Now try to open port with 1 stopbit. </span>
<a name="l00340"></a>00340                 m_commState.StopBits = ONESTOPBIT;
<a name="l00341"></a>00341                 <span class="keywordflow">if</span> (!SetCommState(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, (LPDCB)&amp;m_commState)) {
<a name="l00342"></a>00342                         CloseHandle(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>);
<a name="l00343"></a>00343                         m_handle = INVALID_HANDLE_VALUE;
<a name="l00344"></a>00344                         <a class="code" href="classxsens_1_1_cmt1s.html#e24943020d686262cc9e816000f3d3bd">m_isOpen</a> = <span class="keyword">false</span>;
<a name="l00345"></a>00345                         <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f21d923493c349ed671e995d6cb1cb32c">XRV_INPUTCANNOTBEOPENED</a>);
<a name="l00346"></a>00346                 }
<a name="l00347"></a>00347         }
<a name="l00348"></a>00348         <a class="code" href="classxsens_1_1_cmt1s.html#168c7ac9ed1e5d52f5bddbc0e104ffea">m_port</a> = atoi(&amp;portName[3]);
<a name="l00349"></a>00349         sprintf(<a class="code" href="classxsens_1_1_cmt1s.html#383451f69c25bbee46e2fe17615eb9b2">m_portname</a>, <span class="stringliteral">"%s"</span>, portName);
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         <a class="code" href="classxsens_1_1_cmt1s.html#d54dc31ac6d752df1a0a6df736200860">setTimeout</a>(<a class="code" href="classxsens_1_1_cmt1s.html#82faa3cd6d194a335b52f0a4b49be46c">m_timeout</a>);
<a name="l00352"></a>00352 
<a name="l00353"></a>00353         <span class="comment">// Other initialization functions</span>
<a name="l00354"></a>00354         EscapeCommFunction(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, SETRTS);           <span class="comment">// Enable RTS (for Xbus Master use)</span>
<a name="l00355"></a>00355         <span class="comment">// Set DTR (Calibration sensors need DTR to startup, won't hurt otherwise</span>
<a name="l00356"></a>00356         EscapeCommFunction(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, SETDTR);
<a name="l00357"></a>00357         SetupComm(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>,readBufSize,writeBufSize);   <span class="comment">// Set queue size</span>
<a name="l00358"></a>00358 
<a name="l00359"></a>00359         <span class="comment">// Remove any 'old' data in buffer</span>
<a name="l00360"></a>00360         <span class="comment">//PurgeComm(m_handle, PURGE_TXCLEAR | PURGE_RXCLEAR);</span>
<a name="l00361"></a>00361         PurgeComm(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, PURGE_TXABORT | PURGE_RXABORT | PURGE_TXCLEAR | PURGE_RXCLEAR);
<a name="l00362"></a>00362 <span class="preprocessor">#else // !_WIN32</span>
<a name="l00363"></a>00363 <span class="preprocessor"></span>        <span class="comment">// Open port</span>
<a name="l00364"></a>00364         <a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a> =<a class="code" href="classxsens_1_1_cmt1s.html#31c11cd69aba26459cbd57b5f55b4797"> ::open</a>(portName, O_RDWR | O_NOCTTY);
<a name="l00365"></a>00365         <span class="comment">// O_RDWR: Read+Write</span>
<a name="l00366"></a>00366         <span class="comment">// O_NOCTTY: Raw input, no "controlling terminal"</span>
<a name="l00367"></a>00367         <span class="comment">// O_NDELAY: Don't care about DCD signal</span>
<a name="l00368"></a>00368 
<a name="l00369"></a>00369         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a> &lt; 0) {
<a name="l00370"></a>00370                 <span class="comment">// Port not open</span>
<a name="l00371"></a>00371                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f21d923493c349ed671e995d6cb1cb32c">XRV_INPUTCANNOTBEOPENED</a>;
<a name="l00372"></a>00372         }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374         <span class="comment">// Once here, port is open</span>
<a name="l00375"></a>00375         <a class="code" href="classxsens_1_1_cmt1s.html#e24943020d686262cc9e816000f3d3bd">m_isOpen</a> = <span class="keyword">true</span>;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         <span class="comment">/* Start configuring of port for non-canonical transfer mode */</span>
<a name="l00378"></a>00378         <span class="comment">// Get current options for the port</span>
<a name="l00379"></a>00379         tcgetattr(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, &amp;m_commState);
<a name="l00380"></a>00380         
<a name="l00381"></a>00381         <span class="comment">// Set baudrate. </span>
<a name="l00382"></a>00382         cfsetispeed(&amp;m_commState, baudRate);
<a name="l00383"></a>00383         cfsetospeed(&amp;m_commState, baudRate);
<a name="l00384"></a>00384         
<a name="l00385"></a>00385         <span class="comment">// Enable the receiver and set local mode</span>
<a name="l00386"></a>00386         m_commState.c_cflag |= (CLOCAL | CREAD);
<a name="l00387"></a>00387         <span class="comment">// Set character size to data bits and set no parity Mask the characte size bits</span>
<a name="l00388"></a>00388         m_commState.c_cflag &amp;= ~(CSIZE|PARENB);
<a name="l00389"></a>00389         m_commState.c_cflag |= CS8;             <span class="comment">// Select 8 data bits</span>
<a name="l00390"></a>00390         m_commState.c_cflag |= CSTOPB;  <span class="comment">// send 2 stop bits</span>
<a name="l00391"></a>00391         <span class="comment">// Disable hardware flow control</span>
<a name="l00392"></a>00392         m_commState.c_cflag &amp;= ~CRTSCTS;
<a name="l00393"></a>00393         m_commState.c_lflag &amp;= ~(ECHO|ECHONL|ICANON|ISIG|IEXTEN);
<a name="l00394"></a>00394         <span class="comment">// Disable software flow control</span>
<a name="l00395"></a>00395         m_commState.c_iflag &amp;= ~(IGNBRK|BRKINT|PARMRK|ISTRIP|INLCR|IGNCR|ICRNL|IXON);
<a name="l00396"></a>00396         <span class="comment">// Set Raw output</span>
<a name="l00397"></a>00397         m_commState.c_oflag &amp;= ~OPOST;
<a name="l00398"></a>00398         <span class="comment">// Timeout 0.001 sec for first byte, read minimum of 0 bytes</span>
<a name="l00399"></a>00399         m_commState.c_cc[VMIN]     = 0;
<a name="l00400"></a>00400         m_commState.c_cc[VTIME]    = (<a class="code" href="classxsens_1_1_cmt1s.html#82faa3cd6d194a335b52f0a4b49be46c">m_timeout</a>+99)/100;        <span class="comment">// 1</span>
<a name="l00401"></a>00401 
<a name="l00402"></a>00402         <span class="comment">// Set the new options for the port</span>
<a name="l00403"></a>00403         tcsetattr(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>,TCSANOW, &amp;m_commState);
<a name="l00404"></a>00404         
<a name="l00405"></a>00405         <a class="code" href="classxsens_1_1_cmt1s.html#168c7ac9ed1e5d52f5bddbc0e104ffea">m_port</a> = 0;
<a name="l00406"></a>00406         sprintf(<a class="code" href="classxsens_1_1_cmt1s.html#383451f69c25bbee46e2fe17615eb9b2">m_portname</a>, <span class="stringliteral">"%s"</span>, portName);
<a name="l00407"></a>00407 
<a name="l00408"></a>00408         tcflush(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, TCIOFLUSH);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410         <span class="comment">// setting RTS and DTR; RTS for Xbus Master, DTR for calibration sensors</span>
<a name="l00411"></a>00411         <span class="keywordtype">int</span> cmbits;
<a name="l00412"></a>00412         <span class="keywordflow">if</span> (ioctl(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, TIOCMGET, &amp;cmbits) &lt; 0)
<a name="l00413"></a>00413         {
<a name="l00414"></a>00414                 <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f8b48357051e4a998c816b2ca8479f9f8">XRV_ERROR</a>);
<a name="l00415"></a>00415         }
<a name="l00416"></a>00416         
<a name="l00417"></a>00417         cmbits |= TIOCM_RTS|TIOCM_DTR;
<a name="l00418"></a>00418         
<a name="l00419"></a>00419         <span class="keywordflow">if</span> (ioctl(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, TIOCMSET, &amp;cmbits) &lt; 0)
<a name="l00420"></a>00420         {
<a name="l00421"></a>00421                 <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f8b48357051e4a998c816b2ca8479f9f8">XRV_ERROR</a>);
<a name="l00422"></a>00422         }
<a name="l00423"></a>00423 <span class="preprocessor">#endif // !_WIN32</span>
<a name="l00424"></a>00424 <span class="preprocessor"></span>
<a name="l00425"></a>00425         <a class="code" href="_c_m_t1_8cpp.html#ed3b2d392c8026452ab1558ef59c3fb4">CMT1LOG</a>(<span class="stringliteral">"L1: Port opened\n"</span>);
<a name="l00426"></a>00426         <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>);
<a name="l00427"></a>00427 }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00431"></a>00431 <span class="preprocessor">// Open a communication channel to the given COM port number.</span>
<a name="l00432"></a>00432 <span class="preprocessor"></span><a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1s.html#31c11cd69aba26459cbd57b5f55b4797">Cmt1s::open</a> (  <span class="keyword">const</span> uint32_t portNumber,
<a name="l00433"></a>00433                                                 <span class="keyword">const</span> uint32_t baudRate,
<a name="l00434"></a>00434                                                 uint32_t readBufSize,
<a name="l00435"></a>00435                                                 uint32_t writeBufSize)
<a name="l00436"></a>00436 {
<a name="l00437"></a>00437         <span class="keywordtype">char</span> comFileName[32];
<a name="l00438"></a>00438         
<a name="l00439"></a>00439         <span class="comment">// Create file name</span>
<a name="l00440"></a>00440         sprintf(comFileName, <span class="stringliteral">"COM%d"</span>, portNumber);
<a name="l00441"></a>00441         
<a name="l00442"></a>00442         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1s.html#31c11cd69aba26459cbd57b5f55b4797">Cmt1s::open</a>(comFileName, baudRate, readBufSize, writeBufSize); 
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 <span class="preprocessor">#endif  </span>
<a name="l00445"></a>00445 <span class="preprocessor"></span>
<a name="l00447"></a>00447 <span class="comment">// Read data from the serial port and put it into the data buffer.</span>
<a name="l00448"></a><a class="code" href="classxsens_1_1_cmt1s.html#2237eef35fbf249e18fa3e50474bf8ea">00448</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1s.html#2237eef35fbf249e18fa3e50474bf8ea">Cmt1s::readData</a> (<span class="keyword">const</span> uint32_t maxLength, uint8_t* data,
<a name="l00449"></a>00449                                                                                                         uint32_t* length)
<a name="l00450"></a>00450 {
<a name="l00451"></a>00451         <a class="code" href="_c_m_t1_8cpp.html#ed3b2d392c8026452ab1558ef59c3fb4">CMT1LOG</a>(<span class="stringliteral">"L1: readData, maxlength=%u, length=%p\n"</span>,maxLength,length);
<a name="l00452"></a>00452         uint32_t ln;
<a name="l00453"></a>00453         <span class="keywordflow">if</span> (length == NULL)
<a name="l00454"></a>00454                 length = &amp;ln;
<a name="l00455"></a>00455 
<a name="l00456"></a>00456         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1s.html#e24943020d686262cc9e816000f3d3bd">m_isOpen</a>)
<a name="l00457"></a>00457                 <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f286030c8ef758b70a66bed69f0e43e70">XRV_NOPORTOPEN</a>);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00460"></a>00460 <span class="preprocessor"></span>        BOOL rres = ::ReadFile(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, data, maxLength, length, NULL);
<a name="l00461"></a>00461         <a class="code" href="_c_m_t1_8cpp.html#ed3b2d392c8026452ab1558ef59c3fb4">CMT1LOG</a>(<span class="stringliteral">"L1: readData, ReadFile returns %u (%u)\n"</span>,rres,*length);
<a name="l00462"></a>00462         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1s.html#4908447c2edf0e210ea15f4dcf9a4fa7">m_onBytesReceived</a> != NULL &amp;&amp; *length &gt; 0)
<a name="l00463"></a>00463         {
<a name="l00464"></a>00464                 <a class="code" href="struct_cmt_binary_data.html">CmtBinaryData</a>* bytes = (<a class="code" href="struct_cmt_binary_data.html">CmtBinaryData</a>*) malloc(<span class="keyword">sizeof</span>(<a class="code" href="struct_cmt_binary_data.html">CmtBinaryData</a>));
<a name="l00465"></a>00465                 bytes-&gt;<a class="code" href="struct_cmt_binary_data.html#102c548cd4fe3f51391e39400e556dc6">m_size</a> = *length;
<a name="l00466"></a>00466                 bytes-&gt;<a class="code" href="struct_cmt_binary_data.html#5fadd9338e185406c2dfe83a6eccfdc6">m_portNr</a> = <a class="code" href="classxsens_1_1_cmt1s.html#168c7ac9ed1e5d52f5bddbc0e104ffea">m_port</a>;
<a name="l00467"></a>00467                 memcpy(bytes-&gt;<a class="code" href="struct_cmt_binary_data.html#486cf709c2db8534c6e29234fc263d11">m_data</a>,data,*length);
<a name="l00468"></a>00468 <span class="preprocessor">#ifdef _LOG_CALLBACKS</span>
<a name="l00469"></a>00469 <span class="preprocessor"></span>                <a class="code" href="_c_m_t1_8h.html#990d19ec2de73091adbb95d7057f21a2">CMTLOG</a>(<span class="stringliteral">"C1: onBytesReceived(%d,(%d,%d),%p)\n"</span>,(int32_t) <a class="code" href="classxsens_1_1_cmt1s.html#3a9e83e0c2026f074485729cf1fa358a">m_onBytesReceivedInstance</a>, (int32_t) bytes-&gt;<a class="code" href="struct_cmt_binary_data.html#102c548cd4fe3f51391e39400e556dc6">m_size</a>, (int32_t) bytes-&gt;<a class="code" href="struct_cmt_binary_data.html#5fadd9338e185406c2dfe83a6eccfdc6">m_portNr</a>, <a class="code" href="classxsens_1_1_cmt1s.html#43e99dc8b4d7811d25686d7f21320de5">m_onBytesReceivedParam</a>);
<a name="l00470"></a>00470 <span class="preprocessor">#endif</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span>                <a class="code" href="classxsens_1_1_cmt1s.html#4908447c2edf0e210ea15f4dcf9a4fa7">m_onBytesReceived</a>(m_onBytesReceivedInstance,<a class="code" href="_c_m_tdef_8h.html#cd5beee6c9d90ee2027b5ed87587aa6b3ab32c25afb3d5711997ee149394a611">CMT_CALLBACK_ONBYTESRECEIVED</a>,bytes,<a class="code" href="classxsens_1_1_cmt1s.html#43e99dc8b4d7811d25686d7f21320de5">m_onBytesReceivedParam</a>);
<a name="l00472"></a>00472         }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474         <span class="keywordflow">if</span> (!rres)
<a name="l00475"></a>00475         {
<a name="l00476"></a>00476                 <a class="code" href="_c_m_t1_8cpp.html#ed3b2d392c8026452ab1558ef59c3fb4">CMT1LOG</a>(<span class="stringliteral">"L1: readData, ReadFile returned error %u\n"</span>,::GetLastError());
<a name="l00477"></a>00477                 <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f8b48357051e4a998c816b2ca8479f9f8">XRV_ERROR</a>);
<a name="l00478"></a>00478         }
<a name="l00479"></a>00479 <span class="preprocessor">#else</span>
<a name="l00480"></a>00480 <span class="preprocessor"></span>        *length = read(m_handle, data, maxLength);
<a name="l00481"></a>00481 <span class="preprocessor">#endif</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span>
<a name="l00483"></a>00483 <span class="preprocessor">#ifdef _LOG_RX_TX</span>
<a name="l00484"></a>00484 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (*length &gt; 0)
<a name="l00485"></a>00485         {
<a name="l00486"></a>00486                 <span class="keywordflow">if</span> (rx_log == NULL)
<a name="l00487"></a>00487                 {
<a name="l00488"></a>00488                         <span class="keywordtype">char</span> fname[<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>];
<a name="l00489"></a>00489                         sprintf(fname,<span class="stringliteral">"rx_%03d_%d.log"</span>,(int32_t) <a class="code" href="classxsens_1_1_cmt1s.html#168c7ac9ed1e5d52f5bddbc0e104ffea">m_port</a>,<a class="code" href="classxsens_1_1_cmt1s.html#699e276dea05aed9b120d9668228f842">m_baudrate</a>);
<a name="l00490"></a>00490                         rx_log = fopen(fname,<span class="stringliteral">"wb"</span>);
<a name="l00491"></a>00491                 }
<a name="l00492"></a>00492                 fwrite(data,1,*length,rx_log);
<a name="l00493"></a>00493         }
<a name="l00494"></a>00494 <span class="preprocessor">#endif</span>
<a name="l00495"></a>00495 <span class="preprocessor"></span>
<a name="l00496"></a>00496         <a class="code" href="_c_m_t1_8cpp.html#ed3b2d392c8026452ab1558ef59c3fb4">CMT1LOG</a>((length[0]?<span class="stringliteral">"L1: readData returned success, read %u of %u bytes, first: %02x\n"</span>:<span class="stringliteral">"L1: readData returned success, read %u bytes\n"</span>),length[0],maxLength,data[0]);
<a name="l00497"></a>00497         <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>);
<a name="l00498"></a>00498 }
<a name="l00499"></a>00499 
<a name="l00501"></a>00501 <span class="comment">// Set the callback function for when bytes have been received</span>
<a name="l00502"></a><a class="code" href="classxsens_1_1_cmt1s.html#2f92fc903fbf0404bd142423b9e9f82d">00502</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1s.html#2f92fc903fbf0404bd142423b9e9f82d">Cmt1s::setCallbackFunction</a>(<a class="code" href="_c_m_tdef_8h.html#cd5beee6c9d90ee2027b5ed87587aa6b">CmtCallbackSelector</a> tp, int32_t instance, <a class="code" href="_c_m_tdef_8h.html#b8e2b27a4f48f3278e72be09b7c7b72c">CmtCallbackFunction</a> func, <span class="keywordtype">void</span>* param)
<a name="l00503"></a>00503 {
<a name="l00504"></a>00504         <span class="keywordflow">if</span> (tp == <a class="code" href="_c_m_tdef_8h.html#cd5beee6c9d90ee2027b5ed87587aa6b3ab32c25afb3d5711997ee149394a611">CMT_CALLBACK_ONBYTESRECEIVED</a>)
<a name="l00505"></a>00505         {
<a name="l00506"></a>00506                 <a class="code" href="classxsens_1_1_cmt1s.html#4908447c2edf0e210ea15f4dcf9a4fa7">m_onBytesReceived</a> = func;
<a name="l00507"></a>00507                 <a class="code" href="classxsens_1_1_cmt1s.html#3a9e83e0c2026f074485729cf1fa358a">m_onBytesReceivedInstance</a> = instance;
<a name="l00508"></a>00508                 <a class="code" href="classxsens_1_1_cmt1s.html#43e99dc8b4d7811d25686d7f21320de5">m_onBytesReceivedParam</a> = param;
<a name="l00509"></a>00509                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00510"></a>00510         }
<a name="l00511"></a>00511         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbb0f7b5202c07b851ac168ec4aa61547">XRV_INVALIDPARAM</a>;
<a name="l00512"></a>00512 }
<a name="l00513"></a>00513 
<a name="l00515"></a>00515 <span class="comment">// Set the default timeout value to use in blocking operations.</span>
<a name="l00516"></a><a class="code" href="classxsens_1_1_cmt1s.html#d54dc31ac6d752df1a0a6df736200860">00516</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1s.html#d54dc31ac6d752df1a0a6df736200860">Cmt1s::setTimeout</a> (<span class="keyword">const</span> uint32_t ms)
<a name="l00517"></a>00517 {
<a name="l00518"></a>00518         <a class="code" href="_c_m_t1_8cpp.html#ed3b2d392c8026452ab1558ef59c3fb4">CMT1LOG</a>(<span class="stringliteral">"L1: Setting timeout to %u ms\n"</span>,ms);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520         <a class="code" href="classxsens_1_1_cmt1s.html#82faa3cd6d194a335b52f0a4b49be46c">m_timeout</a> = ms;
<a name="l00521"></a>00521 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00522"></a>00522 <span class="preprocessor"></span>        <span class="comment">// Set COM timeouts</span>
<a name="l00523"></a>00523         COMMTIMEOUTS commTimeouts;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         GetCommTimeouts(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>,&amp;commTimeouts);        <span class="comment">// Fill CommTimeouts structure</span>
<a name="l00526"></a>00526 
<a name="l00527"></a>00527         <span class="comment">// immediate return if data is available, wait 1ms otherwise</span>
<a name="l00528"></a>00528         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1s.html#82faa3cd6d194a335b52f0a4b49be46c">m_timeout</a> &gt; 0)
<a name="l00529"></a>00529         {
<a name="l00530"></a>00530                 commTimeouts.ReadIntervalTimeout = 0;
<a name="l00531"></a>00531                 commTimeouts.ReadTotalTimeoutConstant = <a class="code" href="classxsens_1_1_cmt1s.html#82faa3cd6d194a335b52f0a4b49be46c">m_timeout</a>;      <span class="comment">// ms time</span>
<a name="l00532"></a>00532                 commTimeouts.ReadTotalTimeoutMultiplier = 0; 
<a name="l00533"></a>00533                 commTimeouts.WriteTotalTimeoutConstant = <a class="code" href="classxsens_1_1_cmt1s.html#82faa3cd6d194a335b52f0a4b49be46c">m_timeout</a>;
<a name="l00534"></a>00534                 commTimeouts.WriteTotalTimeoutMultiplier = 0;
<a name="l00535"></a>00535         }
<a name="l00536"></a>00536         <span class="keywordflow">else</span>
<a name="l00537"></a>00537         {
<a name="l00538"></a>00538         <span class="comment">// immediate return whether data is available or not</span>
<a name="l00539"></a>00539                 commTimeouts.ReadIntervalTimeout = MAXDWORD;
<a name="l00540"></a>00540                 commTimeouts.ReadTotalTimeoutConstant = 0;
<a name="l00541"></a>00541                 commTimeouts.ReadTotalTimeoutMultiplier = 0; 
<a name="l00542"></a>00542                 commTimeouts.WriteTotalTimeoutConstant = 0;
<a name="l00543"></a>00543                 commTimeouts.WriteTotalTimeoutMultiplier = 0;
<a name="l00544"></a>00544         }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546         SetCommTimeouts(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, &amp;commTimeouts);       <span class="comment">// Set CommTimeouts structure</span>
<a name="l00547"></a>00547 <span class="preprocessor">#else</span>
<a name="l00548"></a>00548 <span class="preprocessor"></span>        <span class="comment">// Timeout 0.1 sec for first byte, read minimum of 0 bytes</span>
<a name="l00549"></a>00549         <a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>.c_cc[VMIN]     = 0;
<a name="l00550"></a>00550         <a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>.c_cc[VTIME]    = (<a class="code" href="classxsens_1_1_cmt1s.html#82faa3cd6d194a335b52f0a4b49be46c">m_timeout</a>+99)/100;                <span class="comment">// ds time</span>
<a name="l00551"></a>00551 
<a name="l00552"></a>00552         <span class="comment">// Set the new options for the port if it is open</span>
<a name="l00553"></a>00553         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1s.html#e24943020d686262cc9e816000f3d3bd">m_isOpen</a>)
<a name="l00554"></a>00554                 tcsetattr(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>,TCSANOW, &amp;<a class="code" href="classxsens_1_1_cmt1s.html#fdb1351636ece927fc432580e3c831da">m_commState</a>);
<a name="l00555"></a>00555 <span class="preprocessor">#endif</span>
<a name="l00556"></a>00556 <span class="preprocessor"></span>        <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>);
<a name="l00557"></a>00557 }
<a name="l00558"></a>00558 
<a name="l00560"></a>00560 <span class="comment">// Wait for data to arrive or a timeout to occur.</span>
<a name="l00561"></a><a class="code" href="classxsens_1_1_cmt1s.html#7d186b7895b9ad7ba611f50fede6e7bf">00561</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1s.html#7d186b7895b9ad7ba611f50fede6e7bf">Cmt1s::waitForData</a> (<span class="keyword">const</span> uint32_t maxLength,
<a name="l00562"></a>00562                                                           uint8_t* data, uint32_t* length)
<a name="l00563"></a>00563 {
<a name="l00564"></a>00564         <a class="code" href="_c_m_t1_8cpp.html#ed3b2d392c8026452ab1558ef59c3fb4">CMT1LOG</a>(<span class="stringliteral">"L1: waitForData, mto=%u, length=%p\n"</span>,<a class="code" href="classxsens_1_1_cmt1s.html#82faa3cd6d194a335b52f0a4b49be46c">m_timeout</a>,length);
<a name="l00565"></a>00565         uint32_t timeout = <a class="code" href="classxsens_1_1_cmt1s.html#82faa3cd6d194a335b52f0a4b49be46c">m_timeout</a>;
<a name="l00566"></a>00566 
<a name="l00567"></a>00567         uint32_t ln;
<a name="l00568"></a>00568         <span class="keywordflow">if</span> (length == NULL)
<a name="l00569"></a>00569                 length = &amp;ln;
<a name="l00570"></a>00570         uint32_t eTime = <a class="code" href="namespacexsens.html#00d5dce92611428c34961bee5893155f">getTimeOfDay</a>(NULL) + timeout;
<a name="l00571"></a>00571         uint32_t newLength = 0;
<a name="l00572"></a>00572 
<a name="l00573"></a>00573         *length = 0;
<a name="l00574"></a>00574         <span class="keywordflow">while</span> ((*length &lt; maxLength) &amp;&amp; (<a class="code" href="namespacexsens.html#00d5dce92611428c34961bee5893155f">getTimeOfDay</a>() &lt;= eTime))
<a name="l00575"></a>00575         {
<a name="l00576"></a>00576                 <a class="code" href="classxsens_1_1_cmt1s.html#2237eef35fbf249e18fa3e50474bf8ea">readData</a>(maxLength - *length, data + *length, &amp;newLength);
<a name="l00577"></a>00577                 *length += newLength;
<a name="l00578"></a>00578         }
<a name="l00579"></a>00579         <a class="code" href="_c_m_t1_8cpp.html#ed3b2d392c8026452ab1558ef59c3fb4">CMT1LOG</a>(<span class="stringliteral">"L1: waitForData result: read %u of %u bytes\n"</span>,length[0],maxLength);
<a name="l00580"></a>00580 
<a name="l00581"></a>00581         <span class="keywordflow">if</span> (length[0] &lt; maxLength)
<a name="l00582"></a>00582                 <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f936b9b026d2756f421ca552f7ec42228">XRV_TIMEOUT</a>);
<a name="l00583"></a>00583         <span class="keywordflow">else</span>
<a name="l00584"></a>00584                 <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>);
<a name="l00585"></a>00585 }
<a name="l00586"></a>00586 
<a name="l00588"></a>00588 <span class="comment">// Write the data to the serial port.</span>
<a name="l00589"></a><a class="code" href="classxsens_1_1_cmt1s.html#733fc297e7c1d7639f60a7e6bc5ce3bd">00589</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1s.html#733fc297e7c1d7639f60a7e6bc5ce3bd">Cmt1s::writeData</a> (<span class="keyword">const</span> uint32_t length,  <span class="keyword">const</span> uint8_t* data,
<a name="l00590"></a>00590                                                                 uint32_t* written)
<a name="l00591"></a>00591 {
<a name="l00592"></a>00592         uint32_t bytes;
<a name="l00593"></a>00593         <span class="keywordflow">if</span> (written == NULL)
<a name="l00594"></a>00594                 written = &amp;bytes;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1s.html#e24943020d686262cc9e816000f3d3bd">m_isOpen</a>)
<a name="l00597"></a>00597                 <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f286030c8ef758b70a66bed69f0e43e70">XRV_NOPORTOPEN</a>);
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00600"></a>00600 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (WriteFile(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, data, length, written, NULL))
<a name="l00601"></a>00601         {
<a name="l00602"></a>00602 <span class="preprocessor">#ifdef _LOG_RX_TX</span>
<a name="l00603"></a>00603 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (written[0] &gt; 0)
<a name="l00604"></a>00604                 {
<a name="l00605"></a>00605                         <span class="keywordflow">if</span> (tx_log == NULL)
<a name="l00606"></a>00606                         {
<a name="l00607"></a>00607                                 <span class="keywordtype">char</span> fname[<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>];
<a name="l00608"></a>00608                                 sprintf(fname,<span class="stringliteral">"tx_%03d_%d.log"</span>,(int32_t) <a class="code" href="classxsens_1_1_cmt1s.html#168c7ac9ed1e5d52f5bddbc0e104ffea">m_port</a>,<a class="code" href="classxsens_1_1_cmt1s.html#699e276dea05aed9b120d9668228f842">m_baudrate</a>);
<a name="l00609"></a>00609                                 tx_log = fopen(fname,<span class="stringliteral">"wb"</span>);
<a name="l00610"></a>00610                         }
<a name="l00611"></a>00611                         fwrite(data,1,*written,tx_log);
<a name="l00612"></a>00612                 }
<a name="l00613"></a>00613 <span class="preprocessor">#endif</span>
<a name="l00614"></a>00614 <span class="preprocessor"></span>                <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>);
<a name="l00615"></a>00615         }
<a name="l00616"></a>00616         <span class="keywordflow">else</span>
<a name="l00617"></a>00617                 <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f8b48357051e4a998c816b2ca8479f9f8">XRV_ERROR</a>);
<a name="l00618"></a>00618 <span class="preprocessor">#else</span>
<a name="l00619"></a>00619 <span class="preprocessor"></span>        *written = write(<a class="code" href="classxsens_1_1_cmt1s.html#ff3ec4c1b701a30df0f0745ce7a29302">m_handle</a>, data, length);
<a name="l00620"></a>00620 <span class="comment">//      if (*written == length)</span>
<a name="l00621"></a>00621                 <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1s.html#fe15f92b76a9f760cf769035d6a0f5dc">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>);
<a name="l00622"></a>00622 <span class="comment">//      else</span>
<a name="l00623"></a>00623 <span class="comment">//              return (m_lastResult = XRV_ERROR);</span>
<a name="l00624"></a>00624 <span class="preprocessor">#endif</span>
<a name="l00625"></a>00625 <span class="preprocessor"></span>}
<a name="l00626"></a>00626 
<a name="l00630"></a>00630 
<a name="l00632"></a>00632 <span class="comment">// Default constructor, initializes all members to their default values.</span>
<a name="l00633"></a><a class="code" href="classxsens_1_1_cmt1f.html#919b42e4de22630c364ce79ff54d8989">00633</a> <a class="code" href="classxsens_1_1_cmt1f.html#919b42e4de22630c364ce79ff54d8989">Cmt1f::Cmt1f</a>()
<a name="l00634"></a>00634 {
<a name="l00635"></a>00635         <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> = 0;
<a name="l00636"></a>00636         <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> = 0;
<a name="l00637"></a>00637         <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00638"></a>00638         <a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a> = <span class="keyword">true</span>;
<a name="l00639"></a>00639         <a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a> = <span class="keyword">false</span>;
<a name="l00640"></a>00640         <a class="code" href="classxsens_1_1_cmt1f.html#43ddc4718e69ed4fe21c6574da58f4d2">m_filename</a>[0] = <span class="charliteral">'\0'</span>;
<a name="l00641"></a>00641         <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> = 0;
<a name="l00642"></a>00642         <a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a> = <span class="keyword">false</span>;
<a name="l00643"></a>00643         <a class="code" href="classxsens_1_1_cmt1f.html#6da996485f79b6aa12b089b31dc4c654">m_unicode</a> = <span class="keyword">false</span>;
<a name="l00644"></a>00644 }
<a name="l00645"></a>00645 
<a name="l00647"></a>00647 <span class="comment">// Destructor.</span>
<a name="l00648"></a><a class="code" href="classxsens_1_1_cmt1f.html#3f612d9d8c624b8f171a0661ce33ac2a">00648</a> <a class="code" href="classxsens_1_1_cmt1f.html#3f612d9d8c624b8f171a0661ce33ac2a">Cmt1f::~Cmt1f</a>()
<a name="l00649"></a>00649 {
<a name="l00650"></a>00650         <a class="code" href="classxsens_1_1_cmt1f.html#998f005fb3832d4945e53a41b570d634">close</a>();
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00654"></a>00654 <span class="comment">// Write data to the end of the file.</span>
<a name="l00655"></a><a class="code" href="classxsens_1_1_cmt1f.html#761759c365acf23f7e4159b5bedb1ae4">00655</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#761759c365acf23f7e4159b5bedb1ae4">Cmt1f::appendData</a> (<span class="keyword">const</span> uint32_t length,  <span class="keyword">const</span> <span class="keywordtype">void</span>* data)
<a name="l00656"></a>00656 {
<a name="l00657"></a>00657         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l00658"></a>00658                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4f6804db86d07ebd213960d10ff6eb62">XRV_NOFILEOPEN</a>;
<a name="l00659"></a>00659         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a>)
<a name="l00660"></a>00660                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbe5d6d8e99eeb03058667d828b9fb9f3">XRV_READONLY</a>;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a> || <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> != <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a>)
<a name="l00663"></a>00663         {
<a name="l00664"></a>00664                 <a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a> = <span class="keyword">false</span>;
<a name="l00665"></a>00665                 <a class="code" href="_c_m_t1_8cpp.html#de70724c8be1c5773b9d58b9ceba1ac0">FSEEK_R</a>(0);
<a name="l00666"></a>00666         }
<a name="l00667"></a>00667         fwrite(data, 1, length, <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l00668"></a>00668         <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> = <a class="code" href="_c_m_t1_8cpp.html#6cb7c2b71feb2bb1ab857bb639f79b66">FTELL</a>();
<a name="l00669"></a>00669         <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> = <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a>;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671         <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>);
<a name="l00672"></a>00672 }
<a name="l00673"></a>00673 
<a name="l00675"></a>00675 <span class="comment">// Close the file.</span>
<a name="l00676"></a><a class="code" href="classxsens_1_1_cmt1f.html#998f005fb3832d4945e53a41b570d634">00676</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#998f005fb3832d4945e53a41b570d634">Cmt1f::close</a> (<span class="keywordtype">void</span>)
<a name="l00677"></a>00677 {
<a name="l00678"></a>00678         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l00679"></a>00679         {
<a name="l00680"></a>00680 <span class="preprocessor">        #ifdef _WIN32</span>
<a name="l00681"></a>00681 <span class="preprocessor"></span>                fflush(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l00682"></a>00682                 fclose(m_handle);
<a name="l00683"></a>00683 <span class="preprocessor">        #else</span>
<a name="l00684"></a>00684 <span class="preprocessor"></span>                ::fflush(m_handle);
<a name="l00685"></a>00685                 ::fclose(m_handle);
<a name="l00686"></a>00686 <span class="preprocessor">        #endif</span>
<a name="l00687"></a>00687 <span class="preprocessor"></span>        }
<a name="l00688"></a>00688         <a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a> = <span class="keyword">false</span>;
<a name="l00689"></a>00689         <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> = 0;
<a name="l00690"></a>00690         <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> = 0;
<a name="l00691"></a>00691         <a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a> = <span class="keyword">true</span>;
<a name="l00692"></a>00692         m_isOpen = <span class="keyword">false</span>;
<a name="l00693"></a>00693         <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> = 0;
<a name="l00694"></a>00694         <a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a> = <span class="keyword">false</span>;
<a name="l00695"></a>00695 
<a name="l00696"></a>00696         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00697"></a>00697 }
<a name="l00698"></a>00698 
<a name="l00700"></a>00700 <span class="comment">// Close the file and delete it.</span>
<a name="l00701"></a><a class="code" href="classxsens_1_1_cmt1f.html#7f88bf518daead18acd478c53874f59e">00701</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#7f88bf518daead18acd478c53874f59e">Cmt1f::closeAndDelete</a>(<span class="keywordtype">void</span>)
<a name="l00702"></a>00702 {
<a name="l00703"></a>00703         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l00704"></a>00704         {
<a name="l00705"></a>00705 <span class="preprocessor">        #ifdef _WIN32</span>
<a name="l00706"></a>00706 <span class="preprocessor"></span>                fflush(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l00707"></a>00707                 fclose(m_handle);
<a name="l00708"></a>00708 <span class="preprocessor">        #else</span>
<a name="l00709"></a>00709 <span class="preprocessor"></span>                ::fflush(m_handle);
<a name="l00710"></a>00710                 ::fclose(m_handle);
<a name="l00711"></a>00711 <span class="preprocessor">        #endif</span>
<a name="l00712"></a>00712 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a>)
<a name="l00713"></a>00713                         <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbe5d6d8e99eeb03058667d828b9fb9f3">XRV_READONLY</a>;
<a name="l00714"></a>00714                 <span class="keywordflow">else</span>
<a name="l00715"></a>00715                 {
<a name="l00716"></a>00716 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00717"></a>00717 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#6da996485f79b6aa12b089b31dc4c654">m_unicode</a>)
<a name="l00718"></a>00718                         {
<a name="l00719"></a>00719                                 <span class="keywordflow">if</span> (_wremove(<a class="code" href="classxsens_1_1_cmt1f.html#794d7d18b2ea76cf8a6455072261f6b9">m_filename_w</a>) != 0)
<a name="l00720"></a>00720                                         <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbe5d6d8e99eeb03058667d828b9fb9f3">XRV_READONLY</a>;
<a name="l00721"></a>00721                                 <span class="keywordflow">else</span>
<a name="l00722"></a>00722                                         <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00723"></a>00723                         }
<a name="l00724"></a>00724                         <span class="keywordflow">else</span>
<a name="l00725"></a>00725 <span class="preprocessor">#endif</span>
<a name="l00726"></a>00726 <span class="preprocessor"></span>                        {
<a name="l00727"></a>00727 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00728"></a>00728 <span class="preprocessor"></span>                                <span class="keywordflow">if</span> (_unlink(<a class="code" href="classxsens_1_1_cmt1f.html#43ddc4718e69ed4fe21c6574da58f4d2">m_filename</a>) != 0)
<a name="l00729"></a>00729 <span class="preprocessor">#else</span>
<a name="l00730"></a>00730 <span class="preprocessor"></span>                                <span class="keywordflow">if</span> (unlink(<a class="code" href="classxsens_1_1_cmt1f.html#43ddc4718e69ed4fe21c6574da58f4d2">m_filename</a>) != 0)
<a name="l00731"></a>00731 <span class="preprocessor">#endif</span>
<a name="l00732"></a>00732 <span class="preprocessor"></span>                                        <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbe5d6d8e99eeb03058667d828b9fb9f3">XRV_READONLY</a>;
<a name="l00733"></a>00733                                 <span class="keywordflow">else</span>
<a name="l00734"></a>00734                                         <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00735"></a>00735                         }
<a name="l00736"></a>00736                 }
<a name="l00737"></a>00737         }
<a name="l00738"></a>00738         <span class="keywordflow">else</span>
<a name="l00739"></a>00739                 <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4f6804db86d07ebd213960d10ff6eb62">XRV_NOFILEOPEN</a>;
<a name="l00740"></a>00740 
<a name="l00741"></a>00741         <a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a> = <span class="keyword">false</span>;
<a name="l00742"></a>00742         <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> = 0;
<a name="l00743"></a>00743         <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> = 0;
<a name="l00744"></a>00744         <a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a> = <span class="keyword">true</span>;
<a name="l00745"></a>00745         <a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a> = <span class="keyword">false</span>;
<a name="l00746"></a>00746         <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> = 0;
<a name="l00747"></a>00747         <a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a> = <span class="keyword">false</span>;
<a name="l00748"></a>00748 
<a name="l00749"></a>00749         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a>;
<a name="l00750"></a>00750 }
<a name="l00751"></a>00751 
<a name="l00753"></a>00753 <span class="comment">// Create a new file.</span>
<a name="l00754"></a><a class="code" href="classxsens_1_1_cmt1f.html#fe9e7fd93967527fcabfdc0e248f9acc">00754</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#fe9e7fd93967527fcabfdc0e248f9acc">Cmt1f::create</a> (<span class="keyword">const</span> <span class="keywordtype">char</span>* filename)
<a name="l00755"></a>00755 {
<a name="l00756"></a>00756         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l00757"></a>00757                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f16ebfc281a5629d2ace0945e742e2a14">XRV_ALREADYOPEN</a>;
<a name="l00758"></a>00758 
<a name="l00760"></a>00760         <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> = fopen(filename, <span class="stringliteral">"w+b"</span>);      <span class="comment">// open for update (r/w)</span>
<a name="l00761"></a>00761         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> == NULL)
<a name="l00762"></a>00762                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f59919fd84d974987b6c1687fd598092c">XRV_OUTPUTCANNOTBEOPENED</a>;
<a name="l00763"></a>00763 
<a name="l00764"></a>00764 <span class="preprocessor">        #ifdef _WIN32</span>
<a name="l00765"></a>00765 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (_fullpath(<a class="code" href="classxsens_1_1_cmt1f.html#43ddc4718e69ed4fe21c6574da58f4d2">m_filename</a>,filename,<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>) == NULL)
<a name="l00766"></a>00766                 {
<a name="l00767"></a>00767                         fclose(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l00768"></a>00768                         remove(filename);
<a name="l00769"></a>00769                         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbb0f7b5202c07b851ac168ec4aa61547">XRV_INVALIDPARAM</a>;
<a name="l00770"></a>00770                 }
<a name="l00771"></a>00771 <span class="preprocessor">        #else</span>
<a name="l00772"></a>00772 <span class="preprocessor"></span>                <span class="comment">// based on the assumption that this doesn't concern the serial port, handle</span>
<a name="l00773"></a>00773                 <span class="comment">// it the same way using realpath(). Apparently realpath() doesn't require a  </span>
<a name="l00774"></a>00774                 <span class="comment">// maximum length. One would possibly want to write a wrapper for it.</span>
<a name="l00775"></a>00775                 <span class="keywordflow">if</span> (realpath(filename, <a class="code" href="classxsens_1_1_cmt1f.html#43ddc4718e69ed4fe21c6574da58f4d2">m_filename</a>) == NULL)
<a name="l00776"></a>00776         {
<a name="l00777"></a>00777             fclose(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l00778"></a>00778             remove(filename);
<a name="l00779"></a>00779             <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbb0f7b5202c07b851ac168ec4aa61547">XRV_INVALIDPARAM</a>;
<a name="l00780"></a>00780         }
<a name="l00781"></a>00781 <span class="preprocessor">        #endif</span>
<a name="l00782"></a>00782 <span class="preprocessor"></span>        mbstowcs(<a class="code" href="classxsens_1_1_cmt1f.html#794d7d18b2ea76cf8a6455072261f6b9">m_filename_w</a>,<a class="code" href="classxsens_1_1_cmt1f.html#43ddc4718e69ed4fe21c6574da58f4d2">m_filename</a>,<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>);
<a name="l00783"></a>00783         <a class="code" href="classxsens_1_1_cmt1f.html#6da996485f79b6aa12b089b31dc4c654">m_unicode</a> = <span class="keyword">false</span>;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785         <a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a> = <span class="keyword">true</span>;
<a name="l00786"></a>00786         <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> = 0;
<a name="l00787"></a>00787         <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> = 0;
<a name="l00788"></a>00788         <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> = 0;
<a name="l00789"></a>00789         <a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a> = <span class="keyword">true</span>;
<a name="l00790"></a>00790         <a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a> = <span class="keyword">false</span>;
<a name="l00791"></a>00791         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00792"></a>00792 }
<a name="l00793"></a>00793 
<a name="l00795"></a>00795 <span class="comment">// Create a new file.</span>
<a name="l00796"></a><a class="code" href="classxsens_1_1_cmt1f.html#e45a131665d3f94c209d51bdb382425c">00796</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#fe9e7fd93967527fcabfdc0e248f9acc">Cmt1f::create</a> (<span class="keyword">const</span> <span class="keywordtype">wchar_t</span>* filename)
<a name="l00797"></a>00797 {
<a name="l00798"></a>00798         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l00799"></a>00799                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f16ebfc281a5629d2ace0945e742e2a14">XRV_ALREADYOPEN</a>;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00803"></a>00803 <span class="preprocessor">        m_handle = _wfopen(filename, L"w+b");   // open for update (r/w)</span>
<a name="l00804"></a>00804 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> == NULL)
<a name="l00805"></a>00805                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f59919fd84d974987b6c1687fd598092c">XRV_OUTPUTCANNOTBEOPENED</a>;
<a name="l00806"></a>00806 
<a name="l00807"></a>00807         <span class="keywordflow">if</span> (_wfullpath(<a class="code" href="classxsens_1_1_cmt1f.html#794d7d18b2ea76cf8a6455072261f6b9">m_filename_w</a>,filename,<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>) == NULL)
<a name="l00808"></a>00808         {
<a name="l00809"></a>00809                 fclose(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l00810"></a>00810                 _wremove(filename);
<a name="l00811"></a>00811                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbb0f7b5202c07b851ac168ec4aa61547">XRV_INVALIDPARAM</a>;
<a name="l00812"></a>00812         }
<a name="l00813"></a>00813         wcstombs(<a class="code" href="classxsens_1_1_cmt1f.html#43ddc4718e69ed4fe21c6574da58f4d2">m_filename</a>,<a class="code" href="classxsens_1_1_cmt1f.html#794d7d18b2ea76cf8a6455072261f6b9">m_filename_w</a>,<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>);
<a name="l00814"></a>00814 
<a name="l00815"></a>00815         <a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a> = <span class="keyword">true</span>;
<a name="l00816"></a>00816         <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> = 0;
<a name="l00817"></a>00817         <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> = 0;
<a name="l00818"></a>00818         <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> = 0;
<a name="l00819"></a>00819         <a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a> = <span class="keyword">true</span>;
<a name="l00820"></a>00820         <a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a> = <span class="keyword">false</span>;
<a name="l00821"></a>00821 <span class="preprocessor">#else</span>
<a name="l00822"></a>00822 <span class="preprocessor"></span>        <span class="keywordtype">char</span> tFilename[<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>*2];
<a name="l00823"></a>00823         wcstombs(tFilename,<a class="code" href="classxsens_1_1_cmt1f.html#794d7d18b2ea76cf8a6455072261f6b9">m_filename_w</a>,<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>);
<a name="l00824"></a>00824         <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> res = <a class="code" href="classxsens_1_1_cmt1f.html#fe9e7fd93967527fcabfdc0e248f9acc">create</a>(tFilename);
<a name="l00825"></a>00825         <span class="keywordflow">if</span> (res != <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>)
<a name="l00826"></a>00826                 <span class="keywordflow">return</span> res;
<a name="l00827"></a>00827 <span class="preprocessor">#endif</span>
<a name="l00828"></a>00828 <span class="preprocessor"></span>        <a class="code" href="classxsens_1_1_cmt1f.html#6da996485f79b6aa12b089b31dc4c654">m_unicode</a> = <span class="keyword">true</span>;
<a name="l00829"></a>00829         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00830"></a>00830 }
<a name="l00831"></a>00831 
<a name="l00833"></a>00833 <span class="comment">// Delete the given data from the file.</span>
<a name="l00834"></a><a class="code" href="classxsens_1_1_cmt1f.html#5985fee07884566dfe00b1be99b39079">00834</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#5985fee07884566dfe00b1be99b39079">Cmt1f::deleteData</a> (<span class="keyword">const</span> <a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a> start, <span class="keyword">const</span> uint32_t length)
<a name="l00835"></a>00835 {
<a name="l00836"></a>00836         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l00837"></a>00837                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4f6804db86d07ebd213960d10ff6eb62">XRV_NOFILEOPEN</a>;
<a name="l00838"></a>00838         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a>)
<a name="l00839"></a>00839                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbe5d6d8e99eeb03058667d828b9fb9f3">XRV_READONLY</a>;
<a name="l00840"></a>00840 
<a name="l00841"></a>00841         <a class="code" href="classxsens_1_1_cmt1f.html#70655b6aa0207f32b9bb89e0bfbeda07">gotoWrite</a>();
<a name="l00842"></a>00842 
<a name="l00843"></a>00843         <a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a> wPos = start;
<a name="l00844"></a>00844         <a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a> rPos = wPos + length;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846         size_t read1;
<a name="l00847"></a>00847         <a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a> endPos = (start + (<a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a>) length);
<a name="l00848"></a>00848         <span class="keywordflow">if</span> (endPos &lt; <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a>)
<a name="l00849"></a>00849         {
<a name="l00850"></a>00850                 <a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a> remaining = <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> - endPos;
<a name="l00851"></a>00851                 <span class="keywordtype">char</span> buffer[512];
<a name="l00852"></a>00852 
<a name="l00853"></a>00853                 <span class="comment">// copy data</span>
<a name="l00854"></a>00854                 <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(rPos);
<a name="l00855"></a>00855 
<a name="l00856"></a>00856                 <span class="keywordflow">while</span> (remaining &gt; 0)
<a name="l00857"></a>00857                 {
<a name="l00858"></a>00858                         <span class="keywordflow">if</span> (remaining &gt;= 512)
<a name="l00859"></a>00859                                 read1 = fread(buffer,1,512,<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l00860"></a>00860                         <span class="keywordflow">else</span>
<a name="l00861"></a>00861                                 read1 = fread(buffer,1,(size_t) remaining,<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l00862"></a>00862 
<a name="l00863"></a>00863                         remaining -= read1;
<a name="l00864"></a>00864                         rPos += read1;
<a name="l00865"></a>00865 
<a name="l00866"></a>00866                         <span class="comment">// write block to the correct position</span>
<a name="l00867"></a>00867                         <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(wPos);
<a name="l00868"></a>00868                         wPos += fwrite(buffer, 1, read1, <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l00869"></a>00869                         <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(rPos);
<a name="l00870"></a>00870                 }
<a name="l00871"></a>00871                 <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> -= length;
<a name="l00872"></a>00872         }
<a name="l00873"></a>00873         <span class="keywordflow">else</span>
<a name="l00874"></a>00874         {
<a name="l00875"></a>00875                 <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> = start;
<a name="l00876"></a>00876         }
<a name="l00877"></a>00877 
<a name="l00878"></a>00878 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00879"></a>00879 <span class="preprocessor"></span>        int32_t rv = _chsize(_fileno(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>),(int32_t) <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a>);
<a name="l00880"></a>00880 <span class="preprocessor">#else</span>
<a name="l00881"></a>00881 <span class="preprocessor"></span>        int32_t rv = ftruncate(fileno(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>),(int32_t) m_fileSize);
<a name="l00882"></a>00882 <span class="preprocessor">#endif</span>
<a name="l00883"></a>00883 <span class="preprocessor"></span>        int32_t eno = 0;
<a name="l00884"></a>00884         <span class="keywordflow">if</span> (rv != 0)
<a name="l00885"></a>00885                 eno = errno;
<a name="l00886"></a>00886         <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> = start;
<a name="l00887"></a>00887         <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(wPos);
<a name="l00888"></a>00888         <span class="keywordflow">if</span> (rv != 0)
<a name="l00889"></a>00889         {
<a name="l00890"></a>00890                 <span class="keywordflow">switch</span>(eno)
<a name="l00891"></a>00891                 {
<a name="l00892"></a>00892                 <span class="keywordflow">case</span> EACCES:
<a name="l00893"></a>00893                         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f1245df00b8f4110af798ea3ca27b77cc">XRV_BUSY</a>;
<a name="l00894"></a>00894                 <span class="keywordflow">case</span> EBADF:
<a name="l00895"></a>00895                         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4f5eb13f07d04a8bbd68ffb5d86fba0e">XRV_INVALIDINSTANCE</a>;
<a name="l00896"></a>00896                 <span class="keywordflow">case</span> ENOSPC:
<a name="l00897"></a>00897                         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f8bfdb82b26ce336f74b1d0b4151f713a">XRV_OUTOFMEMORY</a>;
<a name="l00898"></a>00898                 <span class="keywordflow">case</span> EINVAL:
<a name="l00899"></a>00899                         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbb0f7b5202c07b851ac168ec4aa61547">XRV_INVALIDPARAM</a>;
<a name="l00900"></a>00900                 <span class="keywordflow">default</span>:
<a name="l00901"></a>00901                         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f8b48357051e4a998c816b2ca8479f9f8">XRV_ERROR</a>;
<a name="l00902"></a>00902                 }
<a name="l00903"></a>00903         }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00906"></a>00906 }       
<a name="l00907"></a>00907 
<a name="l00909"></a>00909 <span class="comment">// Find a string of bytes in the file</span>
<a name="l00910"></a><a class="code" href="classxsens_1_1_cmt1f.html#ca188517973dc3c208cd56c885776ada">00910</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#ca188517973dc3c208cd56c885776ada">Cmt1f::find</a> (<span class="keyword">const</span> <span class="keywordtype">void</span>* needleV, <span class="keyword">const</span> uint32_t needleLength, <a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a>&amp; pos)
<a name="l00911"></a>00911 {
<a name="l00912"></a>00912         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l00913"></a>00913                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4f6804db86d07ebd213960d10ff6eb62">XRV_NOFILEOPEN</a>;
<a name="l00914"></a>00914 
<a name="l00915"></a>00915         <span class="keyword">const</span> <span class="keywordtype">char</span>* needle = (<span class="keyword">const</span> <span class="keywordtype">char</span>*) needleV;
<a name="l00916"></a>00916 
<a name="l00917"></a>00917         <a class="code" href="classxsens_1_1_cmt1f.html#06211472647b5865767127ce404713bf">gotoRead</a>();
<a name="l00918"></a>00918 
<a name="l00919"></a>00919         pos = 0;
<a name="l00920"></a>00920 
<a name="l00921"></a>00921         <span class="keywordtype">char</span> buffer[512];
<a name="l00922"></a>00922         uint32_t bufferPos, needlePos = 0;
<a name="l00923"></a>00923         size_t readBytes;
<a name="l00924"></a>00924         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> &amp; 0x1FF)                                                                          <span class="comment">// read a block of data</span>
<a name="l00925"></a>00925                 readBytes = fread(buffer,1,(512-((size_t) <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> &amp; 0x1FF)),<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l00926"></a>00926         <span class="keywordflow">else</span>
<a name="l00927"></a>00927                 readBytes = fread(buffer,1,512,<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);               <span class="comment">// read a block of data</span>
<a name="l00928"></a>00928         
<a name="l00929"></a>00929         <span class="keywordflow">while</span> (readBytes &gt; 0)
<a name="l00930"></a>00930         {
<a name="l00931"></a>00931                 <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> += readBytes;
<a name="l00932"></a>00932                 bufferPos = 0;
<a name="l00933"></a>00933                 
<a name="l00934"></a>00934                 <span class="keywordflow">while</span> (bufferPos &lt; readBytes &amp;&amp; needlePos &lt; needleLength)
<a name="l00935"></a>00935                 {
<a name="l00936"></a>00936                         <span class="keywordflow">if</span> (buffer[bufferPos] == needle[needlePos])
<a name="l00937"></a>00937                         {
<a name="l00938"></a>00938                                 <span class="comment">// found a byte</span>
<a name="l00939"></a>00939                                 ++needlePos;
<a name="l00940"></a>00940                         }
<a name="l00941"></a>00941                         <span class="keywordflow">else</span>
<a name="l00942"></a>00942                         {
<a name="l00943"></a>00943                                 <span class="keywordflow">if</span> (needlePos &gt; 0)
<a name="l00944"></a>00944                                         needlePos = 0;
<a name="l00945"></a>00945                                 <span class="keywordflow">else</span>
<a name="l00946"></a>00946                                 <span class="keywordflow">if</span> (buffer[bufferPos] == needle[0])
<a name="l00947"></a>00947                                 {
<a name="l00948"></a>00948                                         <span class="comment">// found a byte</span>
<a name="l00949"></a>00949                                         needlePos = 1;
<a name="l00950"></a>00950                                 }
<a name="l00951"></a>00951                         }
<a name="l00952"></a>00952                         ++bufferPos;
<a name="l00953"></a>00953                 }
<a name="l00954"></a>00954                 <span class="keywordflow">if</span> (needlePos &lt; needleLength)
<a name="l00955"></a>00955                         readBytes = fread(buffer,1,512,<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);       <span class="comment">// read next block</span>
<a name="l00956"></a>00956                 <span class="keywordflow">else</span>
<a name="l00957"></a>00957                 {
<a name="l00958"></a>00958                         <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> = <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> + bufferPos - readBytes - needleLength; <span class="comment">// or without needleLength</span>
<a name="l00959"></a>00959                         pos = <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a>; <span class="comment">// - needleLength;</span>
<a name="l00960"></a>00960                         <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(<a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a>);
<a name="l00961"></a>00961                         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00962"></a>00962                 }
<a name="l00963"></a>00963         }
<a name="l00964"></a>00964         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4c54d66f9391c0e311be4cc1cd256ab5">XRV_ENDOFFILE</a>;
<a name="l00965"></a>00965 }
<a name="l00966"></a>00966 
<a name="l00968"></a>00968 <span class="comment">// Flush all data to be written.</span>
<a name="l00969"></a><a class="code" href="classxsens_1_1_cmt1f.html#ebb4f05e2a6b0006da18fd7b21443a89">00969</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#ebb4f05e2a6b0006da18fd7b21443a89">Cmt1f::flushData</a> (<span class="keywordtype">void</span>)
<a name="l00970"></a>00970 {
<a name="l00971"></a>00971         fflush(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l00972"></a>00972 
<a name="l00973"></a>00973         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00974"></a>00974 }
<a name="l00975"></a>00975 
<a name="l00977"></a>00977 <span class="comment">// Retrieve the filename that was last successfully opened.</span>
<a name="l00978"></a><a class="code" href="classxsens_1_1_cmt1f.html#1447858cb01e173d8ee02f45e39a39f2">00978</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#1447858cb01e173d8ee02f45e39a39f2">Cmt1f::getName</a>(<span class="keywordtype">char</span>* filename)<span class="keyword"> const</span>
<a name="l00979"></a>00979 <span class="keyword"></span>{
<a name="l00980"></a>00980         strcpy(filename, <a class="code" href="classxsens_1_1_cmt1f.html#43ddc4718e69ed4fe21c6574da58f4d2">m_filename</a>);
<a name="l00981"></a>00981         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00982"></a>00982 }
<a name="l00983"></a>00983 
<a name="l00985"></a>00985 <span class="comment">// Retrieve the filename that was last successfully opened.</span>
<a name="l00986"></a><a class="code" href="classxsens_1_1_cmt1f.html#6cf9e6b889f186c2d2e41c877f01831e">00986</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#1447858cb01e173d8ee02f45e39a39f2">Cmt1f::getName</a>(<span class="keywordtype">wchar_t</span>* filename)<span class="keyword"> const</span>
<a name="l00987"></a>00987 <span class="keyword"></span>{
<a name="l00988"></a>00988 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00989"></a>00989 <span class="preprocessor"></span>        wcscpy(filename, <a class="code" href="classxsens_1_1_cmt1f.html#794d7d18b2ea76cf8a6455072261f6b9">m_filename_w</a>);
<a name="l00990"></a>00990 <span class="preprocessor">#else</span>
<a name="l00991"></a>00991 <span class="preprocessor"></span>        mbstowcs(filename, <a class="code" href="classxsens_1_1_cmt1f.html#43ddc4718e69ed4fe21c6574da58f4d2">m_filename</a>, <a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>);
<a name="l00992"></a>00992 <span class="preprocessor">#endif</span>
<a name="l00993"></a>00993 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l00994"></a>00994 }
<a name="l00995"></a>00995 
<a name="l00997"></a>00997 <span class="comment">// Change from writing to reading mode</span>
<a name="l00998"></a><a class="code" href="classxsens_1_1_cmt1f.html#06211472647b5865767127ce404713bf">00998</a> <span class="keywordtype">void</span> <a class="code" href="classxsens_1_1_cmt1f.html#06211472647b5865767127ce404713bf">Cmt1f::gotoRead</a>(<span class="keywordtype">void</span>)
<a name="l00999"></a>00999 {
<a name="l01000"></a>01000         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a>)
<a name="l01001"></a>01001                 <span class="keywordflow">return</span>;
<a name="l01002"></a>01002 
<a name="l01003"></a>01003         <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(<a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a>);
<a name="l01004"></a>01004         <a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a> = <span class="keyword">true</span>;
<a name="l01005"></a>01005 }
<a name="l01006"></a>01006 
<a name="l01008"></a>01008 <span class="comment">// Change from reading to writing mode</span>
<a name="l01009"></a><a class="code" href="classxsens_1_1_cmt1f.html#70655b6aa0207f32b9bb89e0bfbeda07">01009</a> <span class="keywordtype">void</span> <a class="code" href="classxsens_1_1_cmt1f.html#70655b6aa0207f32b9bb89e0bfbeda07">Cmt1f::gotoWrite</a>(<span class="keywordtype">void</span>)
<a name="l01010"></a>01010 {
<a name="l01011"></a>01011         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a>)
<a name="l01012"></a>01012                 <span class="keywordflow">return</span>;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014         <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(<a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a>);
<a name="l01015"></a>01015         <a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a> = <span class="keyword">false</span>;
<a name="l01016"></a>01016 }
<a name="l01017"></a>01017 
<a name="l01019"></a>01019 <span class="comment">// Insert the given data into the file.</span>
<a name="l01020"></a><a class="code" href="classxsens_1_1_cmt1f.html#070238db9c4e04ca6e6e72e28a9505e6">01020</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#070238db9c4e04ca6e6e72e28a9505e6">Cmt1f::insertData</a> (<span class="keyword">const</span> <a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a> start, <span class="keyword">const</span> uint32_t length, <span class="keyword">const</span> <span class="keywordtype">void</span>* data)
<a name="l01021"></a>01021 {
<a name="l01022"></a>01022         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l01023"></a>01023                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4f6804db86d07ebd213960d10ff6eb62">XRV_NOFILEOPEN</a>;
<a name="l01024"></a>01024         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a>)
<a name="l01025"></a>01025                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbe5d6d8e99eeb03058667d828b9fb9f3">XRV_READONLY</a>;
<a name="l01026"></a>01026 
<a name="l01027"></a>01027         <a class="code" href="classxsens_1_1_cmt1f.html#70655b6aa0207f32b9bb89e0bfbeda07">gotoWrite</a>();
<a name="l01028"></a>01028 
<a name="l01029"></a>01029         <a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a> rPos = start;
<a name="l01030"></a>01030         <a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a> wPos = rPos + length;
<a name="l01031"></a>01031 
<a name="l01032"></a>01032         size_t read1, read2;
<a name="l01033"></a>01033         <a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a> remaining = <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> - start;
<a name="l01034"></a>01034         size_t bsize = (length &gt; 512)?length:512;
<a name="l01035"></a>01035         <span class="keywordtype">char</span>* buffer1 = (<span class="keywordtype">char</span>*) malloc(bsize);
<a name="l01036"></a>01036         <span class="keywordtype">char</span>* buffer2 = (<span class="keywordtype">char</span>*) malloc(bsize);
<a name="l01037"></a>01037         <span class="keywordtype">char</span>* btemp;
<a name="l01038"></a>01038 
<a name="l01039"></a>01039         <span class="comment">// copy data</span>
<a name="l01040"></a>01040         <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(rPos);
<a name="l01041"></a>01041 
<a name="l01042"></a>01042         <span class="keywordflow">if</span> (remaining &gt;= (<a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a>) bsize)
<a name="l01043"></a>01043                 read1 = fread(buffer1,1,bsize,<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l01044"></a>01044         <span class="keywordflow">else</span>
<a name="l01045"></a>01045                 read1 = fread(buffer1,1,(size_t) remaining,<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l01046"></a>01046 
<a name="l01047"></a>01047         remaining -= read1;
<a name="l01048"></a>01048         rPos += read1;
<a name="l01049"></a>01049 
<a name="l01050"></a>01050         <span class="keywordflow">while</span>(remaining &gt; 0)
<a name="l01051"></a>01051         {
<a name="l01052"></a>01052                 <span class="comment">// move data to correct buffer</span>
<a name="l01053"></a>01053                 read2 = read1;
<a name="l01054"></a>01054                 btemp = buffer1; buffer1 = buffer2; buffer2 = btemp;
<a name="l01055"></a>01055 
<a name="l01056"></a>01056                 <span class="comment">// read next block</span>
<a name="l01057"></a>01057                 <span class="keywordflow">if</span> (remaining &gt;= (<a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a>) bsize)
<a name="l01058"></a>01058                         read1 = fread(buffer1,1,bsize,<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l01059"></a>01059                 <span class="keywordflow">else</span>
<a name="l01060"></a>01060                         read1 = fread(buffer1,1,(size_t) remaining,<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l01061"></a>01061 
<a name="l01062"></a>01062                 remaining -= read1;
<a name="l01063"></a>01063                 rPos += read1;
<a name="l01064"></a>01064 
<a name="l01065"></a>01065                 <span class="comment">// write block to the correct position</span>
<a name="l01066"></a>01066                 <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(wPos);
<a name="l01067"></a>01067                 wPos += fwrite(buffer2, 1, read2, <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l01068"></a>01068                 <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(rPos);
<a name="l01069"></a>01069         }
<a name="l01070"></a>01070 
<a name="l01071"></a>01071         <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(wPos);
<a name="l01072"></a>01072         wPos += fwrite(buffer1, 1, read1, <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l01073"></a>01073 
<a name="l01074"></a>01074         <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(start);
<a name="l01075"></a>01075         <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> = start + fwrite(data, 1, length, <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l01076"></a>01076         <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> += length;
<a name="l01077"></a>01077 
<a name="l01078"></a>01078         free(buffer1);
<a name="l01079"></a>01079         free(buffer2);
<a name="l01080"></a>01080         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l01081"></a>01081 }
<a name="l01082"></a>01082 
<a name="l01084"></a>01084 <span class="comment">// Open a file.</span>
<a name="l01085"></a><a class="code" href="classxsens_1_1_cmt1f.html#c3623b1bd3ab4aa7aaa1cdfe494494d7">01085</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#c3623b1bd3ab4aa7aaa1cdfe494494d7">Cmt1f::open</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* filename, <span class="keyword">const</span> <span class="keywordtype">bool</span> create, <span class="keyword">const</span> <span class="keywordtype">bool</span> readOnly)
<a name="l01086"></a>01086 {
<a name="l01087"></a>01087         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l01088"></a>01088                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f16ebfc281a5629d2ace0945e742e2a14">XRV_ALREADYOPEN</a>;
<a name="l01089"></a>01089 
<a name="l01091"></a>01091         <a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a> = readOnly;
<a name="l01092"></a>01092         <span class="keywordflow">if</span> (readOnly)
<a name="l01093"></a>01093                 <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> = fopen(filename, <span class="stringliteral">"rb"</span>);       <span class="comment">// open for read only (r)</span>
<a name="l01094"></a>01094         <span class="keywordflow">else</span>
<a name="l01095"></a>01095                 <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> = fopen(filename, <span class="stringliteral">"r+b"</span>);      <span class="comment">// open for update (r/w)</span>
<a name="l01096"></a>01096         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> == NULL)
<a name="l01097"></a>01097         {
<a name="l01098"></a>01098                 <span class="keywordflow">if</span> (create)
<a name="l01099"></a>01099                         <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> = fopen(filename, <span class="stringliteral">"w+b"</span>);      <span class="comment">// create for update (r/w)</span>
<a name="l01100"></a>01100                 <span class="keywordflow">else</span>
<a name="l01101"></a>01101                 {
<a name="l01102"></a>01102                         <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> = fopen(filename, <span class="stringliteral">"rb"</span>);       <span class="comment">// open for read only (r)</span>
<a name="l01103"></a>01103                         <a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a> = <span class="keyword">true</span>;
<a name="l01104"></a>01104                 }
<a name="l01105"></a>01105         }
<a name="l01106"></a>01106         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> == NULL)
<a name="l01107"></a>01107                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f21d923493c349ed671e995d6cb1cb32c">XRV_INPUTCANNOTBEOPENED</a>;
<a name="l01108"></a>01108 
<a name="l01109"></a>01109 <span class="preprocessor">        #ifdef _WIN32</span>
<a name="l01110"></a>01110 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (_fullpath(<a class="code" href="classxsens_1_1_cmt1f.html#43ddc4718e69ed4fe21c6574da58f4d2">m_filename</a>,filename,<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>) == NULL)
<a name="l01111"></a>01111                 {
<a name="l01112"></a>01112                         fclose(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l01113"></a>01113                         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbb0f7b5202c07b851ac168ec4aa61547">XRV_INVALIDPARAM</a>;
<a name="l01114"></a>01114                 }
<a name="l01115"></a>01115 <span class="preprocessor">        #else</span>
<a name="l01116"></a>01116 <span class="preprocessor"></span>            <span class="comment">// use the same trick again.</span>
<a name="l01117"></a>01117                 <span class="keywordflow">if</span> (realpath(filename, <a class="code" href="classxsens_1_1_cmt1f.html#43ddc4718e69ed4fe21c6574da58f4d2">m_filename</a>) == NULL)
<a name="l01118"></a>01118                 {
<a name="l01119"></a>01119                     fclose(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l01120"></a>01120                     <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbb0f7b5202c07b851ac168ec4aa61547">XRV_INVALIDPARAM</a>;
<a name="l01121"></a>01121                 }
<a name="l01122"></a>01122 <span class="preprocessor">        #endif</span>
<a name="l01123"></a>01123 <span class="preprocessor"></span>        mbstowcs(<a class="code" href="classxsens_1_1_cmt1f.html#794d7d18b2ea76cf8a6455072261f6b9">m_filename_w</a>,<a class="code" href="classxsens_1_1_cmt1f.html#43ddc4718e69ed4fe21c6574da58f4d2">m_filename</a>,<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>);
<a name="l01124"></a>01124         <a class="code" href="classxsens_1_1_cmt1f.html#6da996485f79b6aa12b089b31dc4c654">m_unicode</a> = <span class="keyword">false</span>;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126         <a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a> = <span class="keyword">true</span>;
<a name="l01127"></a>01127         <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> = 0;
<a name="l01128"></a>01128         <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> = 0;
<a name="l01129"></a>01129         <a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a> = <span class="keyword">true</span>;
<a name="l01130"></a>01130         <a class="code" href="_c_m_t1_8cpp.html#de70724c8be1c5773b9d58b9ceba1ac0">FSEEK_R</a>(0);
<a name="l01131"></a>01131         <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> = <a class="code" href="_c_m_t1_8cpp.html#6cb7c2b71feb2bb1ab857bb639f79b66">FTELL</a>();
<a name="l01132"></a>01132         <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(0);
<a name="l01133"></a>01133         <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>);
<a name="l01134"></a>01134 }
<a name="l01135"></a>01135 
<a name="l01137"></a>01137 <span class="comment">// Open a file.</span>
<a name="l01138"></a><a class="code" href="classxsens_1_1_cmt1f.html#32a7d14f2a28e4624e00168c16c5e5c5">01138</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#c3623b1bd3ab4aa7aaa1cdfe494494d7">Cmt1f::open</a>(<span class="keyword">const</span> <span class="keywordtype">wchar_t</span>* filename, <span class="keyword">const</span> <span class="keywordtype">bool</span> create, <span class="keyword">const</span> <span class="keywordtype">bool</span> readOnly)
<a name="l01139"></a>01139 {
<a name="l01140"></a>01140         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l01141"></a>01141                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f16ebfc281a5629d2ace0945e742e2a14">XRV_ALREADYOPEN</a>;
<a name="l01142"></a>01142 
<a name="l01143"></a>01143 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l01145"></a>01145 <span class="preprocessor">        m_readOnly = readOnly;</span>
<a name="l01146"></a>01146 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (readOnly)
<a name="l01147"></a>01147                 <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> = _wfopen(filename, L<span class="stringliteral">"rb"</span>);    <span class="comment">// open for read only (r)</span>
<a name="l01148"></a>01148         <span class="keywordflow">else</span>
<a name="l01149"></a>01149                 <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> = _wfopen(filename, L<span class="stringliteral">"r+b"</span>);   <span class="comment">// open for update (r/w)</span>
<a name="l01150"></a>01150         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> == NULL)
<a name="l01151"></a>01151         {
<a name="l01152"></a>01152                 <span class="keywordflow">if</span> (create)
<a name="l01153"></a>01153                         <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> = _wfopen(filename, L<span class="stringliteral">"w+b"</span>);   <span class="comment">// create for update (r/w)</span>
<a name="l01154"></a>01154                 <span class="keywordflow">else</span>
<a name="l01155"></a>01155                 {
<a name="l01156"></a>01156                         <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> = _wfopen(filename, L<span class="stringliteral">"rb"</span>);    <span class="comment">// open for read only (r)</span>
<a name="l01157"></a>01157                         <a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a> = <span class="keyword">true</span>;
<a name="l01158"></a>01158                 }
<a name="l01159"></a>01159         }
<a name="l01160"></a>01160         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a> == NULL)
<a name="l01161"></a>01161                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f21d923493c349ed671e995d6cb1cb32c">XRV_INPUTCANNOTBEOPENED</a>;
<a name="l01162"></a>01162 
<a name="l01163"></a>01163         <span class="keywordflow">if</span> (_wfullpath(<a class="code" href="classxsens_1_1_cmt1f.html#794d7d18b2ea76cf8a6455072261f6b9">m_filename_w</a>,filename,<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>) == NULL)
<a name="l01164"></a>01164         {
<a name="l01165"></a>01165                 fclose(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l01166"></a>01166                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbb0f7b5202c07b851ac168ec4aa61547">XRV_INVALIDPARAM</a>;
<a name="l01167"></a>01167         }
<a name="l01168"></a>01168         wcstombs(<a class="code" href="classxsens_1_1_cmt1f.html#43ddc4718e69ed4fe21c6574da58f4d2">m_filename</a>,<a class="code" href="classxsens_1_1_cmt1f.html#794d7d18b2ea76cf8a6455072261f6b9">m_filename_w</a>,<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>);
<a name="l01169"></a>01169 
<a name="l01170"></a>01170         <a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a> = <span class="keyword">true</span>;
<a name="l01171"></a>01171         <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> = 0;
<a name="l01172"></a>01172         <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> = 0;
<a name="l01173"></a>01173         <a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a> = <span class="keyword">true</span>;
<a name="l01174"></a>01174         <a class="code" href="_c_m_t1_8cpp.html#de70724c8be1c5773b9d58b9ceba1ac0">FSEEK_R</a>(0);
<a name="l01175"></a>01175         <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> = <a class="code" href="_c_m_t1_8cpp.html#6cb7c2b71feb2bb1ab857bb639f79b66">FTELL</a>();
<a name="l01176"></a>01176         <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(0);
<a name="l01177"></a>01177 <span class="preprocessor">#else</span>
<a name="l01178"></a>01178 <span class="preprocessor"></span>        <span class="keywordtype">char</span> tFilename[<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>*2];
<a name="l01179"></a>01179         wcstombs(tFilename,filename,<a class="code" href="_c_m_tdef_8h.html#f90bdc6f34330f011e6d12b6dc80dcc5">CMT_MAX_FILENAME_LENGTH</a>*2);
<a name="l01180"></a>01180         <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> res = <a class="code" href="classxsens_1_1_cmt1f.html#c3623b1bd3ab4aa7aaa1cdfe494494d7">open</a>(tFilename,create,readOnly);
<a name="l01181"></a>01181         <span class="keywordflow">if</span> (res != <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>)
<a name="l01182"></a>01182                 <span class="keywordflow">return</span> res;
<a name="l01183"></a>01183 <span class="preprocessor">#endif</span>
<a name="l01184"></a>01184 <span class="preprocessor"></span>        <a class="code" href="classxsens_1_1_cmt1f.html#6da996485f79b6aa12b089b31dc4c654">m_unicode</a> = <span class="keyword">true</span>;
<a name="l01185"></a>01185         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l01186"></a>01186 }
<a name="l01187"></a>01187 
<a name="l01189"></a>01189 <span class="comment">// Read data from the file and put it into the data buffer.</span>
<a name="l01190"></a><a class="code" href="classxsens_1_1_cmt1f.html#d5850430ffa0988986c0b10d218023a2">01190</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#d5850430ffa0988986c0b10d218023a2">Cmt1f::readData</a>(<span class="keyword">const</span> uint32_t maxLength, <span class="keywordtype">void</span>* data, uint32_t* length)
<a name="l01191"></a>01191 {
<a name="l01192"></a>01192         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l01193"></a>01193                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4f6804db86d07ebd213960d10ff6eb62">XRV_NOFILEOPEN</a>;
<a name="l01194"></a>01194 
<a name="l01195"></a>01195         <span class="keywordflow">if</span> (maxLength == 0)
<a name="l01196"></a>01196                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l01197"></a>01197 
<a name="l01198"></a>01198         uint32_t len;
<a name="l01199"></a>01199         <span class="keywordflow">if</span> (length == NULL)
<a name="l01200"></a>01200                 length = &amp;len;
<a name="l01201"></a>01201 
<a name="l01202"></a>01202         <a class="code" href="classxsens_1_1_cmt1f.html#06211472647b5865767127ce404713bf">gotoRead</a>();
<a name="l01203"></a>01203 
<a name="l01204"></a>01204         length[0] = (uint32_t) fread(data,1,maxLength,<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l01205"></a>01205         <span class="keywordflow">if</span> (length[0] == 0)
<a name="l01206"></a>01206                 <span class="keywordflow">return</span> (<a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4c54d66f9391c0e311be4cc1cd256ab5">XRV_ENDOFFILE</a>);
<a name="l01207"></a>01207 
<a name="l01208"></a>01208         <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> += length[0];
<a name="l01209"></a>01209         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l01210"></a>01210 }
<a name="l01211"></a>01211 
<a name="l01213"></a>01213 <span class="comment">// Read data from the file until the terminator and put it into the data buffer.</span>
<a name="l01214"></a><a class="code" href="classxsens_1_1_cmt1f.html#d264a2ef6cdc9a6cfe0b9fce04e466f0">01214</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#d5850430ffa0988986c0b10d218023a2">Cmt1f::readData</a> (<span class="keyword">const</span> uint32_t maxLength, <span class="keyword">const</span> <span class="keywordtype">char</span> terminator, <span class="keywordtype">void</span>* dataV, uint32_t* length)
<a name="l01215"></a>01215 {
<a name="l01216"></a>01216         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l01217"></a>01217                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4f6804db86d07ebd213960d10ff6eb62">XRV_NOFILEOPEN</a>;
<a name="l01218"></a>01218 
<a name="l01219"></a>01219         uint32_t len;
<a name="l01220"></a>01220         <span class="keywordflow">if</span> (length == NULL)
<a name="l01221"></a>01221                 length = &amp;len;
<a name="l01222"></a>01222 
<a name="l01223"></a>01223         <span class="keywordtype">char</span>* data = (<span class="keywordtype">char</span>*) dataV;
<a name="l01224"></a>01224         int32_t readChar;
<a name="l01225"></a>01225 
<a name="l01226"></a>01226         <a class="code" href="classxsens_1_1_cmt1f.html#06211472647b5865767127ce404713bf">gotoRead</a>();
<a name="l01227"></a>01227 
<a name="l01228"></a>01228         *length = 0;
<a name="l01229"></a>01229         readChar = (uint32_t) fgetc(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231         <span class="keywordflow">while</span> (!feof(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>) &amp;&amp; !ferror(<a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>))
<a name="l01232"></a>01232         {
<a name="l01233"></a>01233                 data[*length] = (char) readChar;
<a name="l01234"></a>01234                 ++(*length);
<a name="l01235"></a>01235                 ++<a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a>;
<a name="l01236"></a>01236 
<a name="l01237"></a>01237                 <span class="keywordflow">if</span> (((<span class="keywordtype">char</span>) readChar == terminator) || ((*length) &gt;= maxLength))
<a name="l01238"></a>01238                         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l01239"></a>01239         }
<a name="l01240"></a>01240         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4c54d66f9391c0e311be4cc1cd256ab5">XRV_ENDOFFILE</a>;
<a name="l01241"></a>01241 }
<a name="l01242"></a>01242 
<a name="l01244"></a>01244 <span class="comment">// Set the new absolute read position</span>
<a name="l01245"></a><a class="code" href="classxsens_1_1_cmt1f.html#24f2ef6020512a4a430775413dda24f4">01245</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#24f2ef6020512a4a430775413dda24f4">Cmt1f::setReadPos</a> (<span class="keyword">const</span> <a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a> pos)
<a name="l01246"></a>01246 {
<a name="l01247"></a>01247         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l01248"></a>01248                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4f6804db86d07ebd213960d10ff6eb62">XRV_NOFILEOPEN</a>;
<a name="l01249"></a>01249 
<a name="l01250"></a>01250         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> != pos)
<a name="l01251"></a>01251         {
<a name="l01252"></a>01252                 <a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a> = pos;
<a name="l01253"></a>01253                 <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a>)
<a name="l01254"></a>01254                         <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(<a class="code" href="classxsens_1_1_cmt1f.html#d9e0885e5a86f315d99c9d2dc570e01d">m_readPos</a>);
<a name="l01255"></a>01255         }
<a name="l01256"></a>01256 
<a name="l01257"></a>01257         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l01258"></a>01258 }
<a name="l01259"></a>01259 
<a name="l01261"></a>01261 <span class="comment">// Set the new absolute write position</span>
<a name="l01262"></a><a class="code" href="classxsens_1_1_cmt1f.html#981df3c2c8e7f39a6d7495bf38cac31c">01262</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#981df3c2c8e7f39a6d7495bf38cac31c">Cmt1f::setWritePos</a>(<span class="keyword">const</span> <a class="code" href="_c_m_tf_8h.html#dbed9c7a0b58f20448127d9e869075a8">CmtFilePos</a> pos)
<a name="l01263"></a>01263 {
<a name="l01264"></a>01264         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l01265"></a>01265                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4f6804db86d07ebd213960d10ff6eb62">XRV_NOFILEOPEN</a>;
<a name="l01266"></a>01266         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a>)
<a name="l01267"></a>01267                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbe5d6d8e99eeb03058667d828b9fb9f3">XRV_READONLY</a>;
<a name="l01268"></a>01268 
<a name="l01269"></a>01269         <span class="keywordflow">if</span> (pos == -1)
<a name="l01270"></a>01270         {
<a name="l01271"></a>01271                 <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a>)
<a name="l01272"></a>01272                         <a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a> = <span class="keyword">false</span>;
<a name="l01273"></a>01273                 <a class="code" href="_c_m_t1_8cpp.html#de70724c8be1c5773b9d58b9ceba1ac0">FSEEK_R</a>(0);
<a name="l01274"></a>01274                 <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> = <a class="code" href="_c_m_t1_8cpp.html#6cb7c2b71feb2bb1ab857bb639f79b66">FTELL</a>();
<a name="l01275"></a>01275         }
<a name="l01276"></a>01276         <span class="keywordflow">else</span>
<a name="l01277"></a>01277         {
<a name="l01278"></a>01278                 <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> != pos)
<a name="l01279"></a>01279                 {
<a name="l01280"></a>01280                         <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> = pos;
<a name="l01281"></a>01281                         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1f.html#743b759eb55ae888d44a37c865870bb4">m_reading</a>)
<a name="l01282"></a>01282                                 <a class="code" href="_c_m_t1_8cpp.html#26eeae6d9f6c33e45bc14421e3098a7c">FSEEK</a>(<a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a>);
<a name="l01283"></a>01283                 }
<a name="l01284"></a>01284         }
<a name="l01285"></a>01285 
<a name="l01286"></a>01286         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l01287"></a>01287 }
<a name="l01288"></a>01288 
<a name="l01290"></a>01290 <span class="comment">// Write data to the file.</span>
<a name="l01291"></a><a class="code" href="classxsens_1_1_cmt1f.html#a62d96ccce3c8e407d20bd0346d94991">01291</a> <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f">XsensResultValue</a> <a class="code" href="classxsens_1_1_cmt1f.html#a62d96ccce3c8e407d20bd0346d94991">Cmt1f::writeData</a> (<span class="keyword">const</span> uint32_t length,  <span class="keyword">const</span> <span class="keywordtype">void</span>* data)
<a name="l01292"></a>01292 {
<a name="l01293"></a>01293         <span class="keywordflow">if</span> (!<a class="code" href="classxsens_1_1_cmt1f.html#5f2130dc8026b6a8ad55ffbdaac74150">m_isOpen</a>)
<a name="l01294"></a>01294                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f4f6804db86d07ebd213960d10ff6eb62">XRV_NOFILEOPEN</a>;
<a name="l01295"></a>01295         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#c87b9035d8cbd6d3f7ecff38660a4216">m_readOnly</a>)
<a name="l01296"></a>01296                 <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6fbe5d6d8e99eeb03058667d828b9fb9f3">XRV_READONLY</a>;
<a name="l01297"></a>01297 
<a name="l01298"></a>01298         <a class="code" href="classxsens_1_1_cmt1f.html#70655b6aa0207f32b9bb89e0bfbeda07">gotoWrite</a>();
<a name="l01299"></a>01299         <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> += fwrite(data, 1, length, <a class="code" href="classxsens_1_1_cmt1f.html#9e626704be273497ae4e1408a4aa3b7b">m_handle</a>);
<a name="l01300"></a>01300 
<a name="l01301"></a>01301         <span class="keywordflow">if</span> (<a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a> &gt; <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a>)
<a name="l01302"></a>01302                 <a class="code" href="classxsens_1_1_cmt1f.html#cac663afbb6a51e26577cfd58fb04a71">m_fileSize</a> = <a class="code" href="classxsens_1_1_cmt1f.html#f8745bfcfbf01651a7c99221db5bf1a9">m_writePos</a>;
<a name="l01303"></a>01303 
<a name="l01304"></a>01304         <span class="keywordflow">return</span> <a class="code" href="classxsens_1_1_cmt1f.html#986315e350d8c3c8aed0526e77bd4ed9">m_lastResult</a> = <a class="code" href="xsens__std_8h.html#822a2260a20af524029eef9e9a51ff6f9ecc38cf5706b4dc62700e99abc3bc73">XRV_OK</a>;
<a name="l01305"></a>01305 }
<a name="l01306"></a>01306 
<a name="l01307"></a>01307 }       <span class="comment">// end of xsens namespace</span>
</pre></div>
<div class="tabs">&nbsp;</div>
<hr size="1" />
<address style="text-align: right;">
<small>Generated on 14 Nov 2008 for CMT by <a href="http://www.doxygen.org/index.html">Doxygen</a> 1.5.1-p1</small>
</address>
</body>
</html>
