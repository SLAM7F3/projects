 // ========================================================================
// Program D7_PANELS utilizes ImageMagick's conversion program to crop
// panoramas generated by D7 video cameras down to specified, uniform
// widths and heights measured in pixels.


//			d7_panels

// ========================================================================
// Last updated on 9/1/10; 9/2/10; 9/20/10; 10/7/10
// ========================================================================

#include <iostream>
#include <string>
#include <vector>

#include "general/filefuncs.h"
#include "image/imagefuncs.h"
#include "general/outputfuncs.h"
#include "general/stringfuncs.h"
#include "general/sysfuncs.h"
#include "video/videofuncs.h"

using std::cin;
using std::cout;
using std::endl;
using std::ofstream;
using std::string;
using std::vector;

// ==========================================================================
int main( int argc, char** argv )
{
   string basefilename="image";
//   cout << "Enter panorama base filename:" << endl;
//   cin >> basefilename;
  
//   string imagedir=
//      "~/svn/Documents/tech_challenge/field_tests/July2_mast/frames/";

   string imagedir;
//   cout << "Enter full path to subdirectory containing panorama JPG images:"
//        << endl;
//   cin >> imagedir;

   imagedir=
      "/data/tech_challenge/field_tests/Game_Day/helicopter/sdcard15/FlashTmp0_jpg_frames/";


//   imagedir=
//      "/data/tech_challenge_remote/field_tests/DavisField_Sep19/helicopter/1457/FlashTmp0_jpg_frames/";

//   string imagedir=
//      "/data/tech_challenge_local/field_tests/Burlington_rehearsal_Aug29/helicopter/helicopter0_jpg_frames/";

   string suffix=".jpg";

   int n_start,n_stop;
   videofunc::find_min_max_photo_numbers(imagedir,n_start,n_stop);
   cout << "Enter starting image number:" << endl;
   cin >> n_start;
   
   cout << "Enter stopping image number:" << endl;
   cin >> n_stop;

   int n_skip=1;
   cout << "Enter image number skip:" << endl;
   cin >> n_skip;

   string image_prefix="panel";
//   cout << "Enter cropped image filename prefix:" << endl;
//   cin >> image_prefix;

//   int panel_number=3;
//   cout << "Enter panel number:" << endl;
//   cin >> panel_number;

   const int start_panel_number=2;
   const int stop_panel_number=4;
   for (int panel_number=start_panel_number; 
        panel_number <= stop_panel_number; panel_number++)
   {
      string cropped_basefilename=image_prefix+"_"+
         stringfunc::number_to_string(panel_number)+"_"+basefilename;

//   string cropped_basefilename="cropped_"+basefilename;
      string cropped_images_dir=imagedir+"cropped_images/";
      filefunc::dircreate(cropped_images_dir);
      string cropped_panels_dir=cropped_images_dir+"panels/";
      filefunc::dircreate(cropped_panels_dir);

//      cout << "cropped_images_dir = " << cropped_images_dir << endl;
//      cout << "cropped_panels_dir = " << cropped_panels_dir << endl;
//      outputfunc::enter_continue_char();

// Use GIMP to read off panorama strip's lower left and upper right
// corners measured in pixel coordinates:

      int xstart=65;
      int ystart=304;

      int xstop=1212;
      int ystop=17;

//      int xstart=55;
//      int ystart=310;

//      int xstop=1222;
//      int ystop=17;

//      int xstart=65;
//      int ystart=308;


//      int xstop=1216;
//      int ystop=17;

//      ystart=309;
//      ystop=0;

      if (panel_number==1)
      {
         xstart=64;
         xstop=302;
      }
      if (panel_number==2)
      {
         xstart=304;
         xstop=529;
      }
      else if (panel_number==3)
      {
         xstart=530;
         xstop=754;
      }
      else if (panel_number==4)
      {
         xstart=756;
         xstop=978;
      }
      else if (panel_number==5)
      {
         xstart=980;
         xstop=1214;
      }

      int xoffset=xstart;
      int yoffset=ystop;
      int width=xstop-xstart;
      int height=ystart-ystop;

      const int ndigits=5;
      for (int n=n_start; n<= n_stop; n += n_skip)
      {
         string panorama_filename=imagedir+basefilename+"-"+
            stringfunc::integer_to_string(n,5)+suffix;
         cout << "panorama_filename = " << panorama_filename << endl;

// First crop out 180 degree panorama strip from each input image:

         string cropped_panorama_filename=cropped_images_dir+
            cropped_basefilename+"-"+stringfunc::integer_to_string(n,5)+suffix;
         string unix_command="cp "+panorama_filename+" "+
            cropped_panorama_filename;
         sysfunc::unix_command(unix_command);

         cout << "Cropping file = " << cropped_panorama_filename << endl;
         imagefunc::crop_image(
            cropped_panorama_filename,width,height,xoffset,yoffset);
      } // loop over index n labeling frame numbers

   } // loop over panel_number index
}
